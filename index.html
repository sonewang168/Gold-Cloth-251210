<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚜️ 黃金聖衣生成器 V2 | Gold Cloth Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --gold-primary: #FFD700;
            --gold-light: #FFF8DC;
            --gold-dark: #B8860B;
            --purple-glow: #9B59B6;
            --purple-dark: #6C3483;
            --purple-light: #D7BDE2;
            --cosmic-black: #0a0a12;
            --cosmic-blue: #1a1a2e;
            --neon-cyan: #00FFFF;
            --neon-pink: #FF00FF;
            --energy-red: #FF3366;
            --line-green: #06C755;
            --google-blue: #4285F4;
            --google-red: #EA4335;
            --google-yellow: #FBBC05;
            --google-green: #34A853;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--cosmic-black);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==================== 開場動畫系統 ==================== */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a12 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease, visibility 1s ease;
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .aura-container {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .outer-ring {
            position: absolute;
            width: 280px;
            height: 280px;
            border: 3px solid transparent;
            border-radius: 50%;
            background: linear-gradient(var(--cosmic-black), var(--cosmic-black)) padding-box,
                        linear-gradient(45deg, var(--purple-glow), var(--neon-pink), var(--purple-light), var(--purple-glow)) border-box;
            animation: ringRotate 3s linear infinite;
            box-shadow: 0 0 30px var(--purple-glow), 0 0 60px rgba(155, 89, 182, 0.5), inset 0 0 30px rgba(155, 89, 182, 0.3);
        }

        .outer-ring::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 2px dashed var(--purple-light);
            border-radius: 50%;
            animation: ringRotate 5s linear infinite reverse;
            opacity: 0.5;
        }

        .inner-ring {
            position: absolute;
            width: 220px;
            height: 220px;
            border: 2px solid var(--gold-primary);
            border-radius: 50%;
            animation: ringPulse 2s ease-in-out infinite, ringRotate 4s linear infinite reverse;
            box-shadow: 0 0 20px var(--gold-primary), 0 0 40px rgba(255, 215, 0, 0.3);
        }

        .zodiac-ring {
            position: absolute;
            width: 250px;
            height: 250px;
            animation: ringRotate 20s linear infinite;
        }

        .zodiac-symbol {
            position: absolute;
            font-size: 16px;
            color: var(--gold-light);
            text-shadow: 0 0 10px var(--gold-primary);
            animation: symbolGlow 2s ease-in-out infinite;
        }

        .saint-character {
            font-family: 'Cinzel', serif;
            font-size: 120px;
            font-weight: 900;
            color: transparent;
            background: linear-gradient(135deg, var(--gold-light), var(--gold-primary), var(--gold-dark), var(--gold-primary));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            animation: textShine 2s ease-in-out infinite, saintRotate 4s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            position: relative;
            z-index: 10;
        }

        .saint-character::before {
            content: '聖';
            position: absolute;
            top: 0;
            left: 0;
            color: transparent;
            background: linear-gradient(135deg, var(--purple-glow), var(--neon-pink));
            -webkit-background-clip: text;
            background-clip: text;
            filter: blur(20px);
            animation: glowPulse 2s ease-in-out infinite;
            z-index: -1;
        }

        .particles-container {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--gold-primary);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--gold-primary), 0 0 20px var(--purple-glow);
            animation: particleFloat 3s ease-in-out infinite;
        }

        .splash-progress {
            position: absolute;
            bottom: 100px;
            width: 300px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple-glow), var(--gold-primary), var(--neon-cyan));
            background-size: 200% 100%;
            animation: progressShine 1s linear infinite;
            width: 0%;
            transition: width 0.3s ease;
        }

        .splash-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--purple-light);
            letter-spacing: 3px;
            animation: textFlicker 2s ease-in-out infinite;
        }

        .version-badge {
            margin-top: 15px;
            padding: 5px 15px;
            background: linear-gradient(135deg, var(--purple-glow), var(--purple-dark));
            border-radius: 20px;
            font-size: 10px;
            letter-spacing: 2px;
        }

        /* ==================== 主應用介面 ==================== */
        #main-app {
            display: none;
            min-height: 100vh;
            background: var(--cosmic-black);
        }

        #main-app.active {
            display: block;
            animation: fadeIn 1s ease;
        }

        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        /* 導航列 */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(180deg, rgba(10, 10, 18, 0.95) 0%, rgba(10, 10, 18, 0.8) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(155, 89, 182, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 900;
            color: var(--cosmic-black);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: logoPulse 3s ease-in-out infinite;
        }

        .nav-title {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--gold-light), var(--gold-primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .nav-version {
            font-size: 10px;
            color: var(--purple-light);
            margin-left: 10px;
        }

        .nav-actions {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 15px;
            background: transparent;
            border: 1px solid var(--purple-glow);
            border-radius: 8px;
            color: var(--purple-light);
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover {
            background: var(--purple-glow);
            color: #fff;
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.5);
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border: none;
            color: var(--cosmic-black);
            font-weight: 700;
        }

        .nav-btn.primary:hover {
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }

        .nav-btn.line-btn {
            background: var(--line-green);
            border: none;
            color: #fff;
        }

        .nav-btn.google-btn {
            background: var(--google-blue);
            border: none;
            color: #fff;
        }

        /* 主要內容區 */
        .main-content {
            padding-top: 90px;
            padding-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        /* ==================== 認證管理面板 ==================== */
        .credentials-panel {
            max-width: 900px;
            margin: 0 auto 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(10, 10, 18, 0.9) 100%);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .panel-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .panel-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--purple-glow), var(--purple-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: var(--gold-light);
            letter-spacing: 2px;
        }

        .panel-subtitle {
            font-size: 11px;
            color: var(--purple-light);
            margin-top: 5px;
        }

        .db-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            font-size: 11px;
        }

        .db-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #888;
        }

        .db-status-dot.active {
            background: #00FF88;
            box-shadow: 0 0 10px #00FF88;
            animation: statusPulse 2s ease-in-out infinite;
        }

        /* 認證項目卡片 */
        .credential-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 900px) {
            .credential-cards {
                grid-template-columns: 1fr;
            }
        }

        .credential-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(155, 89, 182, 0.2);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .credential-card:hover {
            border-color: var(--purple-glow);
        }

        .credential-card.connected {
            border-color: #00FF88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .cred-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .cred-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .cred-icon.gemini {
            background: linear-gradient(135deg, #4285F4, #9B59B6);
        }

        .cred-icon.google {
            background: linear-gradient(135deg, var(--google-blue), var(--google-green));
        }

        .cred-icon.photos {
            background: linear-gradient(135deg, var(--google-red), var(--google-yellow), var(--google-green), var(--google-blue));
        }

        .cred-icon.line {
            background: var(--line-green);
        }

        .cred-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 13px;
            color: var(--gold-light);
            letter-spacing: 1px;
        }

        .cred-status {
            font-size: 10px;
            color: #888;
            margin-top: 3px;
        }

        .cred-status.connected {
            color: #00FF88;
        }

        .cred-input-group {
            position: relative;
            margin-bottom: 12px;
        }

        .cred-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 10px;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .cred-input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .cred-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .cred-toggle-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--purple-light);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            transition: color 0.3s ease;
        }

        .cred-toggle-btn:hover {
            color: var(--gold-primary);
        }

        .cred-hint {
            font-size: 12px;
            color: #888;
            text-align: center;
            padding: 5px 0;
            margin-bottom: 5px;
        }

        .auth-status {
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 8px 0;
            text-align: center;
        }

        .auth-status.success {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .auth-status.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .cred-actions {
            display: flex;
            gap: 8px;
        }

        .cred-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .cred-btn.verify {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            color: var(--cosmic-black);
        }

        .cred-btn.save {
            background: linear-gradient(135deg, #00CEC9, #00B894);
            color: #fff;
        }

        .cred-btn.clear {
            background: linear-gradient(135deg, var(--energy-red), #C0392B);
            color: #fff;
        }

        .cred-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .cred-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ==================== 星座選擇器 ==================== */
        .zodiac-selector {
            max-width: 1200px;
            margin: 0 auto 40px;
            padding: 0 20px;
        }

        .section-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--gold-light), var(--gold-primary), var(--gold-light));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }

        .section-subtitle {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--purple-light);
            letter-spacing: 3px;
        }

        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 900px) {
            .zodiac-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .zodiac-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .nav-actions {
                display: none;
            }
            .credential-cards {
                grid-template-columns: 1fr;
            }
        }

        .zodiac-card {
            position: relative;
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(10, 10, 18, 0.9) 100%);
            border: 2px solid rgba(155, 89, 182, 0.2);
            border-radius: 20px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .zodiac-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255, 215, 0, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .zodiac-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--gold-primary);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 215, 0, 0.2);
        }

        .zodiac-card:hover::before {
            opacity: 1;
        }

        .zodiac-card.selected {
            border-color: var(--gold-primary);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4), inset 0 0 30px rgba(255, 215, 0, 0.1);
        }

        .zodiac-card.selected::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: var(--gold-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--cosmic-black);
            font-weight: bold;
            font-size: 16px;
            animation: checkPop 0.3s ease;
        }

        .card-content {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1;
        }

        .zodiac-icon {
            font-size: 48px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px var(--gold-primary));
        }

        .zodiac-name-zh {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--gold-light);
            margin-bottom: 5px;
        }

        .zodiac-name-en {
            font-family: 'Cinzel', serif;
            font-size: 11px;
            color: var(--purple-light);
            letter-spacing: 2px;
        }

        .energy-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0, 0, 0, 0.5);
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple-glow), var(--gold-primary));
            width: 0%;
            transition: width 0.5s ease;
        }

        .zodiac-card:hover .energy-fill {
            width: 100%;
        }

        /* ==================== 生成控制面板 ==================== */
        .generation-panel {
            max-width: 1200px;
            margin: 0 auto 40px;
            padding: 0 20px;
        }

        .gen-controls {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(10, 10, 18, 0.9) 100%);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 20px;
            padding: 30px;
        }

        .upload-zone {
            border: 2px dashed rgba(155, 89, 182, 0.5);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 25px;
        }

        .upload-zone:hover {
            border-color: var(--gold-primary);
            background: rgba(255, 215, 0, 0.05);
        }

        .upload-zone.has-image {
            border-style: solid;
            border-color: var(--gold-primary);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 14px;
            color: var(--purple-light);
        }

        .upload-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            display: none;
        }

        .upload-zone.has-image .upload-preview {
            display: block;
            margin: 0 auto;
        }

        .upload-zone.has-image .upload-icon,
        .upload-zone.has-image .upload-text {
            display: none;
        }

        .edit-uploaded-btn {
            width: 100%;
            padding: 15px 20px;
            margin-top: 10px;
            background: linear-gradient(135deg, var(--purple-glow), var(--neon-pink));
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
        }

        .edit-uploaded-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.6);
        }

        .upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .upload-actions .edit-uploaded-btn {
            flex: 1;
            margin-top: 0;
            padding: 12px 15px;
            font-size: 14px;
        }

        .apply-cloth-btn {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark)) !important;
            color: var(--cosmic-black) !important;
        }

        .apply-cloth-btn:hover {
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4) !important;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-label {
            display: block;
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            color: var(--purple-light);
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .control-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 10px;
            color: #fff;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-select:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        .control-select option {
            background: var(--cosmic-black);
        }

        /* 人物一致性滑桿 */
        .consistency-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #9b59b6, #FFD700);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }

        .consistency-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .consistency-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .consistency-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .generate-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border: none;
            border-radius: 15px;
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--cosmic-black);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .generate-btn:hover::before {
            left: 100%;
        }

        .generate-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .generation-progress {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .generation-progress.active {
            display: block;
        }

        .cosmos-loader {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            position: relative;
        }

        .cosmos-ring {
            position: absolute;
            border: 3px solid transparent;
            border-radius: 50%;
        }

        .cosmos-ring:nth-child(1) {
            width: 100%;
            height: 100%;
            border-top-color: var(--gold-primary);
            animation: cosmosRotate 1.5s linear infinite;
        }

        .cosmos-ring:nth-child(2) {
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            border-right-color: var(--purple-glow);
            animation: cosmosRotate 1.2s linear infinite reverse;
        }

        .cosmos-ring:nth-child(3) {
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
            border-bottom-color: var(--neon-cyan);
            animation: cosmosRotate 0.9s linear infinite;
        }

        .cosmos-center {
            position: absolute;
            width: 40%;
            height: 40%;
            top: 30%;
            left: 30%;
            background: radial-gradient(circle, var(--gold-primary) 0%, transparent 70%);
            border-radius: 50%;
            animation: cosmosPulse 1s ease-in-out infinite;
        }

        .progress-status {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: var(--purple-light);
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .progress-detail {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ==================== 結果展示區 ==================== */
        .results-section {
            max-width: 1200px;
            margin: 0 auto 40px;
            padding: 0 20px;
            display: none;
        }

        .results-section.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .result-card {
            position: relative;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(10, 10, 18, 0.9) 100%);
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            border-color: var(--purple-glow);
            transform: scale(1.02);
        }

        .result-card.selected {
            border-color: var(--gold-primary);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
        }

        .result-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }

        .result-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            color: var(--gold-primary);
        }

        .result-type-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: 700;
        }

        .result-type-badge.ai-badge {
            background: linear-gradient(135deg, #00c853, #00e676);
            color: #000;
        }

        .result-type-badge.placeholder-badge {
            background: rgba(255, 165, 0, 0.8);
            color: #000;
        }

        .result-select-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            padding: 10px 20px;
            background: var(--gold-primary);
            border: none;
            border-radius: 10px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--cosmic-black);
            cursor: pointer;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .result-card:hover .result-select-btn {
            opacity: 1;
            transform: translateY(0);
        }

        /* ==================== AI 解析面板 ==================== */
        .ai-analysis-panel {
            max-width: 1200px;
            margin: 0 auto 40px;
            padding: 0 20px;
            display: none;
        }

        .ai-analysis-panel.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .analysis-container {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(10, 10, 18, 0.9) 100%);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 20px;
            padding: 30px;
        }

        .analysis-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(155, 89, 182, 0.2);
        }

        .analysis-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #00CEC9, #6C5CE7);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            animation: analysisPulse 2s ease-in-out infinite;
        }

        .analysis-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: var(--gold-light);
        }

        .analysis-subtitle {
            font-size: 12px;
            color: var(--purple-light);
            margin-top: 5px;
        }

        .analysis-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .analysis-content {
                grid-template-columns: 1fr;
            }
        }

        .analysis-image-preview {
            width: 100%;
            border-radius: 15px;
            border: 2px solid rgba(155, 89, 182, 0.3);
        }

        .analysis-text {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
        }

        .analysis-section {
            margin-bottom: 20px;
        }

        .analysis-section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--gold-primary);
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-section-content {
            font-size: 14px;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.85);
        }

        .analysis-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .analysis-tag {
            padding: 6px 12px;
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 20px;
            font-size: 11px;
            color: var(--purple-light);
        }

        .analysis-loading {
            text-align: center;
            padding: 40px;
        }

        .analysis-loading .cosmos-loader {
            width: 80px;
            height: 80px;
        }

        /* ==================== 編輯面板 ==================== */
        .editor-panel {
            max-width: 1200px;
            margin: 0 auto 40px;
            padding: 0 20px;
            display: none;
        }

        .editor-panel.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }

        .editor-preview {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(10, 10, 18, 0.9) 100%);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
        }

        .preview-canvas-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        #preview-canvas {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .editor-tools {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(10, 10, 18, 0.9) 100%);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 20px;
            padding: 25px;
            max-height: 700px;
            overflow-y: auto;
        }

        .tool-section {
            margin-bottom: 25px;
        }

        .tool-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--gold-primary);
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(155, 89, 182, 0.2);
        }

        .frame-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .frame-option {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .frame-option:hover {
            border-color: var(--purple-glow);
        }

        .frame-option.selected {
            border-color: var(--gold-primary);
            background: rgba(255, 215, 0, 0.1);
        }

        .watermark-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .watermark-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 13px;
            position: relative;
            transition: all 0.3s ease;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
        }

        .watermark-toggle input {
            display: none;
        }

        .watermark-toggle input:checked + .toggle-switch {
            background: var(--gold-primary);
        }

        .watermark-toggle input:checked + .toggle-switch::after {
            left: 27px;
        }

        .toggle-label {
            font-size: 13px;
            color: var(--purple-light);
        }

        .filter-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .filter-option {
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            color: var(--purple-light);
        }

        .filter-option:hover {
            border-color: var(--purple-glow);
        }

        .filter-option.selected {
            border-color: var(--gold-primary);
            background: rgba(255, 215, 0, 0.1);
            color: var(--gold-primary);
        }

        /* 輸出按鈕組 */
        .output-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .output-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .output-btn.download {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            color: var(--cosmic-black);
        }

        .output-btn.google-photos {
            background: linear-gradient(135deg, var(--google-red), var(--google-yellow));
            color: #fff;
        }

        .output-btn.google-docs {
            background: linear-gradient(135deg, var(--google-blue), #1A73E8);
            color: #fff;
        }

        .output-btn.line-notify {
            background: linear-gradient(135deg, var(--line-green), #00B900);
            color: #fff;
        }

        .output-btn.share {
            background: linear-gradient(135deg, var(--purple-glow), var(--purple-dark));
            color: #fff;
        }

        .output-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .output-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== 歷史記錄面板 ==================== */
        .history-panel {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px 40px;
            display: none;
        }

        .history-panel.active {
            display: block;
        }

        .history-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(155, 89, 182, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            color: var(--gold-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--purple-light);
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .history-item {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(10, 10, 18, 0.9) 100%);
            border: 1px solid rgba(155, 89, 182, 0.2);
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: var(--purple-glow);
            transform: scale(1.03);
        }

        .history-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .history-info {
            padding: 15px;
        }

        .history-zodiac {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--gold-light);
            margin-bottom: 5px;
        }

        .history-date {
            font-size: 11px;
            color: var(--purple-light);
        }

        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .history-action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-action-btn.view {
            background: var(--purple-glow);
            color: #fff;
        }

        .history-action-btn.delete {
            background: var(--energy-red);
            color: #fff;
        }

        /* ==================== Toast 通知 ==================== */
        .toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 25px;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(10, 10, 18, 0.95) 100%);
            border: 1px solid var(--purple-glow);
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastSlideIn 0.3s ease;
            backdrop-filter: blur(10px);
            max-width: 350px;
        }

        .toast.success {
            border-color: #00FF88;
        }

        .toast.error {
            border-color: var(--energy-red);
        }

        .toast.line {
            border-color: var(--line-green);
        }

        .toast-icon {
            font-size: 20px;
        }

        /* ==================== Modal ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9998;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98) 0%, rgba(10, 10, 18, 0.98) 100%);
            border: 1px solid var(--purple-glow);
            border-radius: 25px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            animation: modalPop 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            color: var(--gold-primary);
            margin-bottom: 15px;
        }

        .modal-text {
            color: var(--purple-light);
            margin-bottom: 25px;
            line-height: 1.6;
            white-space: pre-line;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background: var(--gold-primary);
            color: var(--cosmic-black);
        }

        .modal-btn.cancel {
            background: transparent;
            border: 1px solid var(--purple-glow);
            color: var(--purple-light);
        }

        /* ==================== 動畫關鍵幀 ==================== */
        @keyframes ringRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes ringPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes textShine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes saintRotate {
            0%, 100% { transform: rotateY(0deg); }
            25% { transform: rotateY(15deg); }
            75% { transform: rotateY(-15deg); }
        }

        @keyframes glowPulse {
            0%, 100% { opacity: 0.5; filter: blur(20px); }
            50% { opacity: 0.8; filter: blur(30px); }
        }

        @keyframes symbolGlow {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        @keyframes particleFloat {
            0%, 100% { 
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-100vh) translateX(50px);
                opacity: 0;
            }
        }

        @keyframes progressShine {
            from { background-position: -200% 0; }
            to { background-position: 200% 0; }
        }

        @keyframes textFlicker {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes logoPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes checkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes cosmosRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes cosmosPulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes modalPop {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes analysisPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 206, 201, 0.5); }
            50% { box-shadow: 0 0 40px rgba(108, 92, 231, 0.8); }
        }
    </style>
</head>
<body>
    <!-- 開場動畫 -->
    <div id="splash-screen">
        <div class="particles-container" id="splash-particles"></div>
        
        <div class="aura-container">
            <div class="outer-ring"></div>
            <div class="inner-ring"></div>
            <div class="zodiac-ring" id="zodiac-ring"></div>
            <div class="saint-character">聖</div>
        </div>

        <div class="splash-progress">
            <div class="splash-text">INITIALIZING COSMOS</div>
            <div class="progress-bar">
                <div class="progress-fill" id="splash-progress"></div>
            </div>
            <div class="version-badge">VERSION 2.0 PRO</div>
        </div>
    </div>

    <!-- 主應用 -->
    <div id="main-app">
        <canvas class="starfield" id="starfield"></canvas>

        <!-- 導航列 -->
        <nav class="navbar">
            <div class="nav-logo">
                <div class="nav-logo-icon">聖</div>
                <div class="nav-title">GOLD CLOTH GENERATOR</div>
                <span class="nav-version">v2.0</span>
            </div>
            <div class="nav-actions">
                <button class="nav-btn" onclick="showHistory()">📜 歷史</button>
                <button class="nav-btn" onclick="showGooglePhotosHelp()" style="background: linear-gradient(135deg, #EA4335, #FBBC05); border: none; color: #fff;">📷 相簿</button>
                <button class="nav-btn google-btn" onclick="showGoogleDocsHelp()">📄 Docs</button>
                <button class="nav-btn line-btn" onclick="showLineHelp()">🤖 Bot</button>
                <button class="nav-btn primary" onclick="resetApp()">🔄 重置</button>
            </div>
        </nav>

        <!-- 主要內容 -->
        <main class="main-content">
            <!-- 認證管理面板 -->
            <section class="credentials-panel">
                <div class="panel-header">
                    <div class="panel-header-left">
                        <div class="panel-icon">🔐</div>
                        <div>
                            <div class="panel-title">API 認證管理</div>
                            <div class="panel-subtitle">安全儲存於 IndexedDB，永久保存</div>
                        </div>
                    </div>
                    <div class="db-status">
                        <div class="db-status-dot" id="db-status-dot"></div>
                        <span id="db-status-text">IndexedDB 初始化中...</span>
                    </div>
                </div>

                <div class="credential-cards">
                    <!-- Gemini API -->
                    <div class="credential-card" id="gemini-card">
                        <div class="cred-header">
                            <div class="cred-icon gemini">🤖</div>
                            <div>
                                <div class="cred-title">GEMINI API</div>
                                <div class="cred-status" id="gemini-status">尚未設定</div>
                            </div>
                        </div>
                        <div class="cred-input-group">
                            <input type="password" class="cred-input" id="gemini-key" placeholder="輸入 Gemini API Key...">
                            <button class="cred-toggle-btn" onclick="togglePassword('gemini-key')">👁️</button>
                        </div>
                        <div class="cred-actions">
                            <button class="cred-btn verify" onclick="verifyGeminiKey()">✓ 驗證</button>
                            <button class="cred-btn save" onclick="saveCredential('gemini')">💾 儲存</button>
                            <button class="cred-btn clear" onclick="clearCredential('gemini')">🗑️ 清除</button>
                        </div>
                    </div>

                    <!-- Google Docs API (OAuth 前端授權) -->
                    <div class="credential-card" id="google-card">
                        <div class="cred-header">
                            <div class="cred-icon google">📄</div>
                            <div>
                                <div class="cred-title">GOOGLE DOCS 圖鑑</div>
                                <div class="cred-status" id="google-status">尚未授權</div>
                            </div>
                            <button class="cred-help-btn" onclick="showDocsHelp()">❓</button>
                        </div>
                        <div class="cred-input-group">
                            <input type="text" class="cred-input" id="google-client-id" placeholder="Google OAuth Client ID（從 GCP Console 取得）">
                            <button class="cred-toggle-btn" onclick="togglePassword('google-client-id')">👁️</button>
                        </div>
                        <div class="cred-input-group">
                            <input type="text" class="cred-input" id="google-doc-url" placeholder="📖 圖鑑文件連結（貼上 Google Doc 網址）">
                            <button class="cred-toggle-btn" onclick="window.open(document.getElementById('google-doc-url').value, '_blank')" title="開啟圖鑑">🔗</button>
                        </div>
                        <div class="auth-status" id="googleAuthStatus" style="display:none;"></div>
                        <div class="cred-hint">💡 先建立一份空白 Google Doc，貼上連結後每次上傳會自動追加內容</div>
                        <div class="cred-actions">
                            <button class="cred-btn verify" onclick="handleGoogleAuthorize()">🔐 授權</button>
                            <button class="cred-btn save" onclick="saveCredential('google')">💾 儲存</button>
                            <button class="cred-btn clear" onclick="clearGoogleAuth()">🗑️ 登出</button>
                        </div>
                    </div>

                    <!-- Google Photos API -->
                    <div class="credential-card" id="photos-card">
                        <div class="cred-header">
                            <div class="cred-icon photos">📷</div>
                            <div>
                                <div class="cred-title">GOOGLE PHOTOS</div>
                                <div class="cred-status" id="photos-status">尚未設定</div>
                            </div>
                        </div>
                        <div class="cred-input-group">
                            <input type="password" class="cred-input" id="photos-client-id" placeholder="OAuth Client ID...">
                            <button class="cred-toggle-btn" onclick="togglePassword('photos-client-id')">👁️</button>
                        </div>
                        <div class="cred-input-group">
                            <input type="password" class="cred-input" id="photos-client-secret" placeholder="OAuth Client Secret...">
                            <button class="cred-toggle-btn" onclick="togglePassword('photos-client-secret')">👁️</button>
                        </div>
                        <div class="cred-input-group">
                            <input type="text" class="cred-input" id="photos-album-name" placeholder="📷 相簿名稱 (預設: 黃金聖衣收藏)">
                        </div>
                        <div class="cred-input-group">
                            <input type="text" class="cred-input" id="photos-album-id" placeholder="📁 相簿 ID (可選，首次上傳後自動儲存)">
                        </div>
                        <div class="cred-hint">💡 首次上傳會建立相簿並記住 ID，之後都會上傳到同一本</div>
                        <div class="cred-actions">
                            <button class="cred-btn verify" onclick="authorizeGooglePhotos()">🔐 授權</button>
                            <button class="cred-btn save" onclick="saveCredential('photos')">💾 儲存</button>
                            <button class="cred-btn clear" onclick="clearCredential('photos')">🗑️ 清除</button>
                        </div>
                    </div>

                    <!-- LINE Bot (Messaging API) -->
                    <div class="credential-card" id="line-card">
                        <div class="cred-header">
                            <div class="cred-icon line">🤖</div>
                            <div>
                                <div class="cred-title">LINE BOT + GAS</div>
                                <div class="cred-status" id="line-status">尚未設定</div>
                            </div>
                        </div>
                        <div class="cred-input-group">
                            <input type="password" class="cred-input" id="line-channel-token" placeholder="Channel Access Token...">
                            <button class="cred-toggle-btn" onclick="togglePassword('line-channel-token')">👁️</button>
                        </div>
                        <div class="cred-input-group">
                            <input type="password" class="cred-input" id="line-user-id" placeholder="您的 LINE User ID...">
                            <button class="cred-toggle-btn" onclick="togglePassword('line-user-id')">👁️</button>
                        </div>
                        <div class="cred-input-group">
                            <input type="text" class="cred-input" id="line-gas-url" placeholder="GAS 網頁應用程式網址 (解決 CORS)...">
                        </div>
                        <div class="cred-actions">
                            <button class="cred-btn verify" onclick="verifyLineBot()">✓ 驗證</button>
                            <button class="cred-btn save" onclick="saveCredential('line')">💾 儲存</button>
                            <button class="cred-btn clear" onclick="clearCredential('line')">🗑️ 清除</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 星座選擇器 -->
            <section class="zodiac-selector">
                <div class="section-header">
                    <h2 class="section-title">選擇黃金聖衣</h2>
                    <p class="section-subtitle">SELECT YOUR GOLD CLOTH</p>
                </div>
                <div class="zodiac-grid" id="zodiac-grid"></div>
            </section>

            <!-- 生成控制 -->
            <section class="generation-panel">
                <div class="gen-controls">
                    <div class="panel-header">
                        <div class="panel-header-left">
                            <div class="panel-icon">🎨</div>
                            <div>
                                <div class="panel-title">生成設定</div>
                                <div class="panel-subtitle">GENERATION SETTINGS</div>
                            </div>
                        </div>
                    </div>

                    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                        <div class="upload-icon">📷</div>
                        <div class="upload-text">點擊或拖放上傳人物圖像</div>
                        <img class="upload-preview" id="upload-preview" alt="Preview">
                        <input type="file" id="file-input" accept="image/*" hidden onchange="handleFileUpload(event)">
                    </div>
                    <div class="upload-actions" id="upload-actions" style="display: none;">
                        <button class="edit-uploaded-btn" id="edit-uploaded-btn" onclick="editUploadedImage()">
                            ✨ 直接編輯（加相框/濾鏡）
                        </button>
                        <button class="edit-uploaded-btn apply-cloth-btn" id="apply-cloth-btn" onclick="applyGoldCloth()">
                            ⚜️ 套用黃金聖衣
                        </button>
                    </div>

                    <div class="control-row">
                        <div class="control-group">
                            <label class="control-label">🎨 風格模式 (20種)</label>
                            <select class="control-select" id="style-mode">
                                <option value="chibi">🎀 Q版可愛風</option>
                                <option value="anime">🎌 日式動漫</option>
                                <option value="realistic">📷 寫實照片</option>
                                <option value="pixel">👾 像素復古</option>
                                <option value="watercolor">🎨 水彩畫風</option>
                                <option value="oil">🖼️ 油畫風格</option>
                                <option value="cyberpunk">🌃 賽博龐克</option>
                                <option value="steampunk">⚙️ 蒸汽龐克</option>
                                <option value="ink">🖋️ 水墨國畫</option>
                                <option value="comic">💥 美式漫畫</option>
                                <option value="3d">🎮 3D 渲染</option>
                                <option value="gold">✨ 純金雕塑</option>
                                <option value="fantasy">🧙 奇幻魔法</option>
                                <option value="gothic">🦇 哥德暗黑</option>
                                <option value="pop">🌈 普普藝術</option>
                                <option value="sketch">✏️ 鉛筆素描</option>
                                <option value="neon">💡 霓虹燈光</option>
                                <option value="vintage">📺 復古懷舊</option>
                                <option value="minimalist">⬜ 極簡風格</option>
                                <option value="baroque">👑 巴洛克華麗</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label">🖼️ 背景設定 (20種)</label>
                            <select class="control-select" id="bg-setting">
                                <option value="white">⬜ 純白背景</option>
                                <option value="transparent">🔲 透明背景</option>
                                <option value="cosmos">🌌 宇宙星空</option>
                                <option value="temple">🏛️ 聖域神殿</option>
                                <option value="galaxy">🌀 銀河漩渦</option>
                                <option value="aurora">🌈 極光夜空</option>
                                <option value="fire">🔥 烈焰燃燒</option>
                                <option value="ice">❄️ 冰雪世界</option>
                                <option value="forest">🌲 神秘森林</option>
                                <option value="ocean">🌊 深海海底</option>
                                <option value="mountain">🏔️ 雪山之巔</option>
                                <option value="sunset">🌅 黃昏夕陽</option>
                                <option value="lightning">⚡ 雷電風暴</option>
                                <option value="cherry">🌸 櫻花飛舞</option>
                                <option value="ruins">🏚️ 古代遺跡</option>
                                <option value="palace">🏰 黃金宮殿</option>
                                <option value="volcano">🌋 火山熔岩</option>
                                <option value="cloud">☁️ 雲端天堂</option>
                                <option value="night">🌙 星月夜晚</option>
                                <option value="rainbow">🌈 彩虹光芒</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-row">
                        <div class="control-group">
                            <label class="control-label">📐 輸出尺寸</label>
                            <select class="control-select" id="output-size">
                                <option value="512">512 x 512 (LINE 貼圖)</option>
                                <option value="1024">1024 x 1024 (高畫質)</option>
                                <option value="2048">2048 x 2048 (超高畫質)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label">🤖 AI 模型</label>
                            <select class="control-select" id="ai-model">
                                <option value="gemini-2.0-flash-exp-image-generation">Gemini 2.0 Flash</option>
                                <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image</option>
                                <option value="imagen-4.0-generate-001">Imagen 4（高品質）</option>
                            </select>
                        </div>
                    </div>

                    <!-- 人物一致性控制 -->
                    <div class="control-row" style="margin-top: 15px;">
                        <div class="control-group" style="flex: 1;">
                            <label class="control-label">👤 人物一致性 <span id="consistency-value">50%</span></label>
                            <input type="range" id="character-consistency" min="0" max="100" value="50" 
                                   class="consistency-slider" oninput="updateConsistencyValue(this.value)">
                            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-top: 5px;">
                                <span>創意多變</span>
                                <span>高度一致</span>
                            </div>
                        </div>
                    </div>

                    <button class="generate-btn" id="generate-btn" onclick="startGeneration()">
                        ⚡ 燃燒小宇宙！生成聖衣 ⚡
                    </button>

                    <div class="generation-progress" id="generation-progress">
                        <div class="cosmos-loader">
                            <div class="cosmos-ring"></div>
                            <div class="cosmos-ring"></div>
                            <div class="cosmos-ring"></div>
                            <div class="cosmos-center"></div>
                        </div>
                        <div class="progress-status" id="progress-status">正在喚醒小宇宙...</div>
                        <div class="progress-detail" id="progress-detail">準備生成 4 張候選圖像</div>
                    </div>
                </div>
            </section>

            <!-- 結果展示 -->
            <section class="results-section" id="results-section">
                <div class="section-header">
                    <h2 class="section-title">選擇您的聖衣</h2>
                    <p class="section-subtitle">SELECT YOUR FAVORITE</p>
                </div>
                <div class="results-grid" id="results-grid"></div>
            </section>

            <!-- AI 解析面板 -->
            <section class="ai-analysis-panel" id="ai-analysis-panel">
                <div class="analysis-container">
                    <div class="analysis-header">
                        <div class="analysis-icon">🧠</div>
                        <div>
                            <div class="analysis-title">AI 智能解析</div>
                            <div class="analysis-subtitle">Powered by Gemini Vision</div>
                        </div>
                    </div>
                    <div class="analysis-loading" id="analysis-loading">
                        <div class="cosmos-loader">
                            <div class="cosmos-ring"></div>
                            <div class="cosmos-ring"></div>
                            <div class="cosmos-ring"></div>
                            <div class="cosmos-center"></div>
                        </div>
                        <div class="progress-status">AI 正在分析圖像...</div>
                    </div>
                    <div class="analysis-content" id="analysis-content" style="display: none;">
                        <div>
                            <img class="analysis-image-preview" id="analysis-image" src="" alt="分析圖像">
                        </div>
                        <div class="analysis-text">
                            <div class="analysis-section">
                                <div class="analysis-section-title">📖 圖像描述</div>
                                <div class="analysis-section-content" id="analysis-description"></div>
                            </div>
                            <div class="analysis-section">
                                <div class="analysis-section-title">⚜️ 聖衣特徵</div>
                                <div class="analysis-section-content" id="analysis-features"></div>
                            </div>
                            <div class="analysis-section">
                                <div class="analysis-section-title">🎨 藝術風格</div>
                                <div class="analysis-section-content" id="analysis-style"></div>
                            </div>
                            <div class="analysis-section">
                                <div class="analysis-section-title">🏷️ 標籤</div>
                                <div class="analysis-tags" id="analysis-tags"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 編輯面板 -->
            <section class="editor-panel" id="editor-panel">
                <div class="section-header">
                    <h2 class="section-title">圖像編輯</h2>
                    <p class="section-subtitle">IMAGE EDITOR</p>
                </div>
                <div class="editor-container">
                    <div class="editor-preview">
                        <div class="preview-canvas-container">
                            <canvas id="preview-canvas" width="512" height="512"></canvas>
                        </div>
                    </div>
                    <div class="editor-tools">
                        <div class="tool-section">
                            <div class="tool-title">🖼️ 相框樣式 (20種)</div>
                            <div class="frame-options" style="flex-wrap: wrap; gap: 8px;">
                                <div class="frame-option selected" data-frame="none" onclick="selectFrame('none')">無</div>
                                <div class="frame-option" data-frame="gold" onclick="selectFrame('gold')">🏆</div>
                                <div class="frame-option" data-frame="cosmos" onclick="selectFrame('cosmos')">🌌</div>
                                <div class="frame-option" data-frame="fire" onclick="selectFrame('fire')">🔥</div>
                                <div class="frame-option" data-frame="ice" onclick="selectFrame('ice')">❄️</div>
                                <div class="frame-option" data-frame="lightning" onclick="selectFrame('lightning')">⚡</div>
                                <div class="frame-option" data-frame="rainbow" onclick="selectFrame('rainbow')">🌈</div>
                                <div class="frame-option" data-frame="star" onclick="selectFrame('star')">⭐</div>
                                <div class="frame-option" data-frame="heart" onclick="selectFrame('heart')">💖</div>
                                <div class="frame-option" data-frame="diamond" onclick="selectFrame('diamond')">💎</div>
                                <div class="frame-option" data-frame="crown" onclick="selectFrame('crown')">👑</div>
                                <div class="frame-option" data-frame="dragon" onclick="selectFrame('dragon')">🐉</div>
                                <div class="frame-option" data-frame="phoenix" onclick="selectFrame('phoenix')">🔶</div>
                                <div class="frame-option" data-frame="sakura" onclick="selectFrame('sakura')">🌸</div>
                                <div class="frame-option" data-frame="ocean" onclick="selectFrame('ocean')">🌊</div>
                                <div class="frame-option" data-frame="night" onclick="selectFrame('night')">🌙</div>
                                <div class="frame-option" data-frame="sun" onclick="selectFrame('sun')">☀️</div>
                                <div class="frame-option" data-frame="celtic" onclick="selectFrame('celtic')">☘️</div>
                                <div class="frame-option" data-frame="baroque" onclick="selectFrame('baroque')">🎭</div>
                                <div class="frame-option" data-frame="tech" onclick="selectFrame('tech')">💠</div>
                            </div>
                        </div>

                        <div class="tool-section">
                            <div class="tool-title">💧 浮水印設定</div>
                            <div class="watermark-options">
                                <label class="watermark-toggle">
                                    <input type="checkbox" id="wm-date" checked onchange="updatePreview()">
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">日期浮水印</span>
                                </label>
                                <label class="watermark-toggle">
                                    <input type="checkbox" id="wm-zodiac" checked onchange="updatePreview()">
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">星座標記</span>
                                </label>
                                <label class="watermark-toggle">
                                    <input type="checkbox" id="wm-logo" onchange="updatePreview()">
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">聖衣標誌</span>
                                </label>
                            </div>
                        </div>

                        <div class="tool-section">
                            <div class="tool-title">✨ 濾鏡效果 (20種)</div>
                            <div class="filter-options" style="flex-wrap: wrap; gap: 8px;">
                                <div class="filter-option selected" data-filter="none" onclick="selectFilter('none')">原圖</div>
                                <div class="filter-option" data-filter="golden" onclick="selectFilter('golden')">黃金</div>
                                <div class="filter-option" data-filter="cosmos" onclick="selectFilter('cosmos')">宇宙</div>
                                <div class="filter-option" data-filter="vintage" onclick="selectFilter('vintage')">復古</div>
                                <div class="filter-option" data-filter="warm" onclick="selectFilter('warm')">暖色</div>
                                <div class="filter-option" data-filter="cool" onclick="selectFilter('cool')">冷色</div>
                                <div class="filter-option" data-filter="sepia" onclick="selectFilter('sepia')">懷舊</div>
                                <div class="filter-option" data-filter="bw" onclick="selectFilter('bw')">黑白</div>
                                <div class="filter-option" data-filter="neon" onclick="selectFilter('neon')">霓虹</div>
                                <div class="filter-option" data-filter="sunset" onclick="selectFilter('sunset')">夕陽</div>
                                <div class="filter-option" data-filter="ocean" onclick="selectFilter('ocean')">海洋</div>
                                <div class="filter-option" data-filter="forest" onclick="selectFilter('forest')">森林</div>
                                <div class="filter-option" data-filter="fire" onclick="selectFilter('fire')">烈焰</div>
                                <div class="filter-option" data-filter="ice" onclick="selectFilter('ice')">冰霜</div>
                                <div class="filter-option" data-filter="dream" onclick="selectFilter('dream')">夢幻</div>
                                <div class="filter-option" data-filter="pop" onclick="selectFilter('pop')">普普</div>
                                <div class="filter-option" data-filter="dramatic" onclick="selectFilter('dramatic')">戲劇</div>
                                <div class="filter-option" data-filter="soft" onclick="selectFilter('soft')">柔和</div>
                                <div class="filter-option" data-filter="sharp" onclick="selectFilter('sharp')">銳利</div>
                                <div class="filter-option" data-filter="aurora" onclick="selectFilter('aurora')">極光</div>
                            </div>
                        </div>

                        <div class="output-actions">
                            <button class="output-btn download" onclick="downloadImage()">
                                💾 下載圖像
                            </button>
                            <button class="output-btn google-photos" onclick="uploadToGooglePhotos()" id="btn-google-photos">
                                📷 上傳 Google 相簿
                            </button>
                            <button class="output-btn google-docs" onclick="uploadToGoogleDocs()" id="btn-google-docs">
                                📄 上傳 Google Docs
                            </button>
                            <button class="output-btn line-notify" onclick="sendLineBot()" id="btn-line-notify">
                                🤖 LINE Bot 通知
                            </button>
                            <button class="output-btn share" onclick="shareImage()">
                                📤 分享圖像
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 歷史記錄 -->
            <section class="history-panel" id="history-panel">
                <div class="section-header">
                    <h2 class="section-title">生成歷史</h2>
                    <p class="section-subtitle">GENERATION HISTORY (IndexedDB)</p>
                </div>
                <div class="history-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">總生成數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-storage">0 KB</div>
                        <div class="stat-label">儲存空間</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-zodiac">-</div>
                        <div class="stat-label">最常用星座</div>
                    </div>
                </div>
                <div class="history-grid" id="history-grid"></div>
            </section>
        </main>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon" id="modal-icon">🎉</div>
            <div class="modal-title" id="modal-title">成功</div>
            <div class="modal-text" id="modal-text">操作已完成</div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal()">關閉</button>
                <button class="modal-btn confirm" id="modal-confirm" onclick="modalConfirm()">確認</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== IndexedDB 封裝 ====================
        class GoldClothDB {
            constructor() {
                this.dbName = 'GoldClothGeneratorDB';
                this.dbVersion = 2;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => {
                        console.error('IndexedDB 開啟失敗');
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB 連線成功');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // 認證資料表
                        if (!db.objectStoreNames.contains('credentials')) {
                            const credStore = db.createObjectStore('credentials', { keyPath: 'id' });
                            credStore.createIndex('type', 'type', { unique: false });
                        }

                        // 生成歷史資料表
                        if (!db.objectStoreNames.contains('history')) {
                            const histStore = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                            histStore.createIndex('zodiac', 'zodiac', { unique: false });
                            histStore.createIndex('createdAt', 'createdAt', { unique: false });
                        }

                        // AI 解析快取
                        if (!db.objectStoreNames.contains('analysis_cache')) {
                            const cacheStore = db.createObjectStore('analysis_cache', { keyPath: 'imageHash' });
                        }

                        console.log('IndexedDB 結構升級完成');
                    };
                });
            }

            // 儲存認證
            async saveCredential(type, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['credentials'], 'readwrite');
                    const store = transaction.objectStore('credentials');
                    const request = store.put({
                        id: type,
                        type: type,
                        data: data,
                        updatedAt: new Date().toISOString()
                    });

                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            // 讀取認證
            async getCredential(type) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['credentials'], 'readonly');
                    const store = transaction.objectStore('credentials');
                    const request = store.get(type);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // 刪除認證
            async deleteCredential(type) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['credentials'], 'readwrite');
                    const store = transaction.objectStore('credentials');
                    const request = store.delete(type);

                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            // 儲存歷史記錄
            async saveHistory(record) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['history'], 'readwrite');
                    const store = transaction.objectStore('history');
                    const request = store.add({
                        ...record,
                        createdAt: new Date().toISOString()
                    });

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // 讀取所有歷史
            async getAllHistory() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['history'], 'readonly');
                    const store = transaction.objectStore('history');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const results = request.result.sort((a, b) => 
                            new Date(b.createdAt) - new Date(a.createdAt)
                        );
                        resolve(results);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            // 刪除歷史記錄
            async deleteHistory(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['history'], 'readwrite');
                    const store = transaction.objectStore('history');
                    const request = store.delete(id);

                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            // 儲存 AI 解析快取
            async saveAnalysisCache(imageHash, analysis) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['analysis_cache'], 'readwrite');
                    const store = transaction.objectStore('analysis_cache');
                    const request = store.put({
                        imageHash: imageHash,
                        analysis: analysis,
                        cachedAt: new Date().toISOString()
                    });

                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            // 取得 AI 解析快取
            async getAnalysisCache(imageHash) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['analysis_cache'], 'readonly');
                    const store = transaction.objectStore('analysis_cache');
                    const request = store.get(imageHash);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // 計算儲存空間
            async getStorageEstimate() {
                if (navigator.storage && navigator.storage.estimate) {
                    const estimate = await navigator.storage.estimate();
                    return {
                        used: estimate.usage,
                        quota: estimate.quota
                    };
                }
                return { used: 0, quota: 0 };
            }
        }

        // ==================== 全域變數 ====================
        const db = new GoldClothDB();

        // ==================== Google OAuth 設定 ====================
        const GOOGLE_TOKEN_KEY = 'gold_cloth_google_token';
        const GOOGLE_TOKEN_EXPIRE = 24 * 60 * 60; // 24 小時
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/photoslibrary.appendonly https://www.googleapis.com/auth/photoslibrary.readonly';
        const GOOGLE_DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        
        let googleTokenClient = null;
        let gapiInited = false;
        let gisInited = false;

        const ZODIAC_DATA = [
            { id: 'aries', symbol: '♈', name: '白羊座', nameEn: 'Aries', color: '#FF6B6B' },
            { id: 'taurus', symbol: '♉', name: '金牛座', nameEn: 'Taurus', color: '#4ECDC4' },
            { id: 'gemini', symbol: '♊', name: '雙子座', nameEn: 'Gemini', color: '#FFE66D' },
            { id: 'cancer', symbol: '♋', name: '巨蟹座', nameEn: 'Cancer', color: '#95E1D3' },
            { id: 'leo', symbol: '♌', name: '獅子座', nameEn: 'Leo', color: '#F38181' },
            { id: 'virgo', symbol: '♍', name: '處女座', nameEn: 'Virgo', color: '#AA96DA' },
            { id: 'libra', symbol: '♎', name: '天秤座', nameEn: 'Libra', color: '#FCBAD3' },
            { id: 'scorpio', symbol: '♏', name: '天蠍座', nameEn: 'Scorpio', color: '#A8D8EA' },
            { id: 'sagittarius', symbol: '♐', name: '射手座', nameEn: 'Sagittarius', color: '#FF9F43' },
            { id: 'capricorn', symbol: '♑', name: '摩羯座', nameEn: 'Capricorn', color: '#6C5CE7' },
            { id: 'aquarius', symbol: '♒', name: '水瓶座', nameEn: 'Aquarius', color: '#00CEC9' },
            { id: 'pisces', symbol: '♓', name: '雙魚座', nameEn: 'Pisces', color: '#FD79A8' }
        ];

        const CLOTH_DESCRIPTIONS = {
            aries: "Golden Aries Cloth, ram horn shoulder armor, crossed chest plate, silver starlight aura",
            taurus: "Golden Taurus Cloth, massive shoulder guards, bull horns helmet, fortress-like defense",
            gemini: "Golden Gemini Cloth, dual-faced design, mirror shoulder plates, flowing cape, light and shadow contrast",
            cancer: "Golden Cancer Cloth, crab claw shoulder armor, shell-like back guard, oceanic wave patterns",
            leo: "Golden Leo Cloth, lion mane radiant shoulder plates, roaring lion chest emblem, fierce solar patterns",
            virgo: "Golden Virgo Cloth, lotus crown helmet, sacred scripture chest patterns, meditation pose, serene aura",
            libra: "Golden Libra Cloth, scale-shaped shoulder guards, balanced symmetrical design, six weapons attached",
            scorpio: "Golden Scorpio Cloth, scorpion tail extending from back, venomous hook arm guards, red gem chest center",
            sagittarius: "Golden Sagittarius Cloth, magnificent golden wings, holding golden bow, unicorn horn helmet, hopeful radiance",
            capricorn: "Golden Capricorn Cloth, swordsman style, angular shoulder plates, goat horn helmet, sword sheath at waist",
            aquarius: "Golden Aquarius Cloth, flowing wave patterns, water vessel chest design, fluid helmet design, serene ice beauty",
            pisces: "Golden Pisces Cloth, elegant fish fin shoulder plates, twin fish spiral emblem, rose vine arm decorations, noble cold beauty"
        };

        let appState = {
            credentials: {
                gemini: null,
                google: null,
                photos: null,
                line: null
            },
            selectedZodiac: null,
            uploadedImage: null,
            generatedImages: [],
            selectedResult: null,
            currentFrame: 'none',
            currentFilter: 'none',
            currentAnalysis: null
        };

        // ==================== 開場動畫 ====================
        function initSplashScreen() {
            const particlesContainer = document.getElementById('splash-particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 3 + 's';
                particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                particlesContainer.appendChild(particle);
            }

            const zodiacRing = document.getElementById('zodiac-ring');
            ZODIAC_DATA.forEach((zodiac, index) => {
                const symbol = document.createElement('div');
                symbol.className = 'zodiac-symbol';
                const angle = (index / 12) * 360;
                const radius = 125;
                const x = Math.cos((angle - 90) * Math.PI / 180) * radius;
                const y = Math.sin((angle - 90) * Math.PI / 180) * radius;
                symbol.style.left = `calc(50% + ${x}px - 8px)`;
                symbol.style.top = `calc(50% + ${y}px - 8px)`;
                symbol.style.animationDelay = (index * 0.1) + 's';
                symbol.textContent = zodiac.symbol;
                zodiacRing.appendChild(symbol);
            });

            const progressFill = document.getElementById('splash-progress');
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                    setTimeout(hideSplashScreen, 500);
                }
                progressFill.style.width = progress + '%';
            }, 200);
        }

        async function hideSplashScreen() {
            // 初始化 IndexedDB
            try {
                await db.init();
                document.getElementById('db-status-dot').classList.add('active');
                document.getElementById('db-status-text').textContent = 'IndexedDB 已連線';
                
                // 載入已儲存的認證
                await loadSavedCredentials();
            } catch (error) {
                console.error('IndexedDB 初始化失敗:', error);
                document.getElementById('db-status-text').textContent = 'IndexedDB 錯誤';
            }

            const splash = document.getElementById('splash-screen');
            splash.classList.add('hidden');
            document.getElementById('main-app').classList.add('active');
            initStarfield();
            initZodiacGrid();
        }

        // ==================== 認證管理 ====================
        async function loadSavedCredentials() {
            // 載入 Gemini
            const gemini = await db.getCredential('gemini');
            if (gemini && gemini.data) {
                document.getElementById('gemini-key').value = gemini.data.key || '';
                appState.credentials.gemini = gemini.data;
                updateCredentialStatus('gemini', true);
            }

            // 載入 Google Docs
            const google = await db.getCredential('google');
            if (google && google.data) {
                document.getElementById('google-client-id').value = google.data.clientId || '';
                document.getElementById('google-doc-url').value = google.data.docUrl || '';
                appState.credentials.google = google.data;
                // 嘗試載入已儲存的 Token
                if (gapiInited) {
                    loadSavedGoogleToken();
                }
            }

            // 載入 Google Photos
            const photos = await db.getCredential('photos');
            if (photos && photos.data) {
                document.getElementById('photos-client-id').value = photos.data.clientId || '';
                document.getElementById('photos-client-secret').value = photos.data.clientSecret || '';
                document.getElementById('photos-album-name').value = photos.data.albumName || '';
                document.getElementById('photos-album-id').value = photos.data.albumId || '';
                appState.credentials.photos = photos.data;
                updateCredentialStatus('photos', true);
            }

            // 載入 LINE Bot
            const line = await db.getCredential('line');
            if (line && line.data) {
                document.getElementById('line-channel-token').value = line.data.channelToken || '';
                document.getElementById('line-user-id').value = line.data.userId || '';
                document.getElementById('line-gas-url').value = line.data.gasUrl || '';
                appState.credentials.line = line.data;
                updateCredentialStatus('line', true);
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function updateCredentialStatus(type, connected, name = null) {
            const statusEl = document.getElementById(`${type}-status`);
            const cardEl = document.getElementById(`${type}-card`);
            
            if (connected) {
                statusEl.textContent = name ? `✓ ${name}` : '✓ 已設定';
                statusEl.classList.add('connected');
                cardEl.classList.add('connected');
            } else {
                statusEl.textContent = '尚未設定';
                statusEl.classList.remove('connected');
                cardEl.classList.remove('connected');
            }
        }

        async function saveCredential(type) {
            try {
                let data = {};
                
                switch (type) {
                    case 'gemini':
                        data = { key: document.getElementById('gemini-key').value.trim() };
                        break;
                    case 'google':
                        data = {
                            clientId: document.getElementById('google-client-id').value.trim(),
                            docUrl: document.getElementById('google-doc-url').value.trim()
                        };
                        break;
                    case 'photos':
                        data = {
                            clientId: document.getElementById('photos-client-id').value.trim(),
                            clientSecret: document.getElementById('photos-client-secret').value.trim(),
                            albumName: document.getElementById('photos-album-name').value.trim() || '黃金聖衣收藏',
                            albumId: document.getElementById('photos-album-id').value.trim() || ''
                        };
                        break;
                    case 'line':
                        data = { 
                            channelToken: document.getElementById('line-channel-token').value.trim(),
                            userId: document.getElementById('line-user-id').value.trim(),
                            gasUrl: document.getElementById('line-gas-url').value.trim()
                        };
                        break;
                }

                const hasData = data.key || data.channelToken || data.clientId || data.gasUrl;
                if (!hasData) {
                    showToast('error', '請先輸入認證資訊');
                    return;
                }

                await db.saveCredential(type, data);
                appState.credentials[type] = data;
                updateCredentialStatus(type, true);
                showToast('success', `${type.toUpperCase()} 認證已儲存至 IndexedDB`);
            } catch (error) {
                showToast('error', '儲存失敗: ' + error.message);
            }
        }

        async function clearCredential(type) {
            try {
                await db.deleteCredential(type);
                appState.credentials[type] = null;
                
                switch (type) {
                    case 'gemini':
                        document.getElementById('gemini-key').value = '';
                        break;
                    case 'google':
                        document.getElementById('google-client-id').value = '';
                        document.getElementById('google-doc-url').value = '';
                        clearGoogleAuth();
                        break;
                    case 'photos':
                        document.getElementById('photos-client-id').value = '';
                        document.getElementById('photos-client-secret').value = '';
                        document.getElementById('photos-album-name').value = '';
                        document.getElementById('photos-album-id').value = '';
                        break;
                    case 'line':
                        document.getElementById('line-channel-token').value = '';
                        document.getElementById('line-user-id').value = '';
                        document.getElementById('line-gas-url').value = '';
                        break;
                }
                
                updateCredentialStatus(type, false);
                showToast('success', `${type.toUpperCase()} 認證已清除`);
            } catch (error) {
                showToast('error', '清除失敗: ' + error.message);
            }
        }

        async function verifyGeminiKey() {
            const key = document.getElementById('gemini-key').value.trim();
            if (!key) {
                showToast('error', '請輸入 API Key');
                return;
            }

            showToast('info', '驗證中...');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                
                if (response.ok) {
                    showToast('success', 'Gemini API 驗證成功！');
                    updateCredentialStatus('gemini', true);
                } else {
                    throw new Error('API Key 無效');
                }
            } catch (error) {
                showToast('error', 'Gemini API 驗證失敗');
                updateCredentialStatus('gemini', false);
            }
        }

        // ==================== Google OAuth 認證系統 ====================
        
        // 初始化 Google API
        function initGoogleAPI() {
            if (typeof gapi !== 'undefined') {
                gapi.load('client', async function() {
                    try {
                        await gapi.client.init({ discoveryDocs: GOOGLE_DISCOVERY_DOCS });
                        gapiInited = true;
                        loadSavedGoogleToken();
                        console.log('✅ Google API 已初始化');
                    } catch (err) {
                        console.error('GAPI init failed:', err);
                    }
                });
            }
        }
        
        // 儲存 Google Token
        function saveGoogleToken(token) {
            try {
                localStorage.setItem(GOOGLE_TOKEN_KEY, JSON.stringify({
                    token: token,
                    savedAt: Date.now(),
                    expiresIn: GOOGLE_TOKEN_EXPIRE
                }));
            } catch (e) {
                console.error('儲存 Token 失敗:', e);
            }
        }
        
        // 載入已儲存的 Token
        function loadSavedGoogleToken() {
            try {
                const saved = localStorage.getItem(GOOGLE_TOKEN_KEY);
                if (!saved) return false;
                
                const tokenData = JSON.parse(saved);
                const elapsed = (Date.now() - tokenData.savedAt) / 1000;
                
                if (elapsed < tokenData.expiresIn - 300) {
                    gapi.client.setToken(tokenData.token);
                    gisInited = true;
                    
                    const remaining = Math.floor((tokenData.expiresIn - elapsed) / 3600);
                    const mins = Math.floor(((tokenData.expiresIn - elapsed) % 3600) / 60);
                    
                    const statusEl = document.getElementById('googleAuthStatus');
                    if (statusEl) {
                        statusEl.innerHTML = `✅ 已授權（剩餘約 ${remaining > 0 ? remaining + ' 小時 ' : ''}${mins} 分鐘）`;
                        statusEl.className = 'auth-status success';
                        statusEl.style.display = 'block';
                    }
                    updateCredentialStatus('google', true, '已授權');
                    return true;
                } else {
                    localStorage.removeItem(GOOGLE_TOKEN_KEY);
                    return false;
                }
            } catch (e) {
                return false;
            }
        }
        
        // 檢查 Token 是否有效
        function isGoogleTokenValid() {
            if (typeof gapi === 'undefined' || !gapi.client) return false;
            const token = gapi.client.getToken();
            if (!token) return false;
            
            try {
                const saved = localStorage.getItem(GOOGLE_TOKEN_KEY);
                if (!saved) return !!token;
                const tokenData = JSON.parse(saved);
                return (Date.now() - tokenData.savedAt) / 1000 < tokenData.expiresIn - 60;
            } catch (e) {
                return !!token;
            }
        }
        
        // 取得已儲存的 Token
        function getStoredGoogleToken() {
            try {
                if (typeof gapi !== 'undefined' && gapi.client) {
                    const gapiToken = gapi.client.getToken();
                    if (gapiToken) return gapiToken;
                }
                
                const saved = localStorage.getItem(GOOGLE_TOKEN_KEY);
                if (!saved) return null;
                const tokenData = JSON.parse(saved);
                const elapsed = (Date.now() - tokenData.savedAt) / 1000;
                if (elapsed < tokenData.expiresIn - 60) {
                    return tokenData.token;
                }
                return null;
            } catch (e) {
                return null;
            }
        }
        
        // 初始化 Token Client
        function initGoogleTokenClient() {
            const clientId = document.getElementById('google-client-id').value.trim();
            if (!clientId) {
                showToast('error', '請先輸入 Google Client ID');
                showDocsHelp();
                return false;
            }
            
            if (typeof google === 'undefined' || !google.accounts) {
                showToast('error', 'Google API 尚未載入，請稍後再試');
                return false;
            }
            
            googleTokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: GOOGLE_SCOPES,
                callback: function(response) {
                    if (response.error) {
                        showToast('error', '授權失敗: ' + response.error);
                        return;
                    }
                    
                    gisInited = true;
                    saveGoogleToken(response);
                    
                    const statusEl = document.getElementById('googleAuthStatus');
                    if (statusEl) {
                        statusEl.innerHTML = '✅ 已授權（24 小時有效）';
                        statusEl.className = 'auth-status success';
                        statusEl.style.display = 'block';
                    }
                    
                    updateCredentialStatus('google', true, '已授權');
                    showToast('success', '✅ Google 授權成功！現在可以上傳到 Google Docs');
                }
            });
            return true;
        }
        
        // 處理 Google 授權
        function handleGoogleAuthorize() {
            if (isGoogleTokenValid()) {
                showToast('success', '授權仍然有效');
                return;
            }
            if (!initGoogleTokenClient()) return;
            googleTokenClient.requestAccessToken({ prompt: '' });
        }
        
        // 清除 Google 授權
        function clearGoogleAuth() {
            localStorage.removeItem(GOOGLE_TOKEN_KEY);
            if (typeof gapi !== 'undefined' && gapi.client) {
                gapi.client.setToken(null);
            }
            gisInited = false;
            
            const statusEl = document.getElementById('googleAuthStatus');
            if (statusEl) {
                statusEl.style.display = 'none';
            }
            
            document.getElementById('google-client-id').value = '';
            updateCredentialStatus('google', false);
            showToast('success', '已登出 Google');
        }

        function showDocsHelp() {
            showModal(
                '📄',
                'Google Docs 設定說明',
                `【功能說明】
━━━━━━━━━━━━━━━━━━━
✅ 每次上傳自動建立新文件
✅ 包含圖片 + AI 分析（圖文並茂）
✅ 文件儲存在你的 Google Drive

【取得 Client ID】
━━━━━━━━━━━━━━━━━━━
1. 前往 console.cloud.google.com
2. 建立新專案或選擇現有專案
3. 啟用 Google Drive API
4. 前往「憑證」→「建立憑證」→「OAuth 用戶端 ID」
5. 應用程式類型：網頁應用程式
6. 授權的 JavaScript 來源：
   ${window.location.origin}
7. 複製 Client ID 貼到上方欄位

【OAuth 同意畫面】
━━━━━━━━━━━━━━━━━━━
1. 前往「OAuth 同意畫面」
2. 用戶類型：外部
3. 填寫應用程式名稱
4. 新增範圍：
   • drive.file
   • documents
5. 新增測試使用者（你的 Gmail）

【使用方式】
━━━━━━━━━━━━━━━━━━━
1. 貼上 Client ID
2. 點擊「🔐 授權」
3. 登入 Google 帳號
4. 允許存取 Google Drive
5. 授權成功後即可上傳！`,
                () => { closeModal(); }
            );
        }

        async function authorizeGooglePhotos() {
            const clientId = document.getElementById('photos-client-id').value.trim();
            const clientSecret = document.getElementById('photos-client-secret').value.trim();
            
            if (!clientId || !clientSecret) {
                showToast('error', '請輸入 OAuth Client ID 和 Client Secret');
                return;
            }

            // Google Photos API OAuth 2.0 授權流程
            const scope = 'https://www.googleapis.com/auth/photoslibrary.appendonly https://www.googleapis.com/auth/photoslibrary.readonly';
            const redirectUri = window.location.origin + window.location.pathname;
            
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${encodeURIComponent(clientId)}` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&response_type=code` +
                `&scope=${encodeURIComponent(scope)}` +
                `&access_type=offline` +
                `&prompt=consent`;

            showModal(
                '📷',
                'Google Photos 授權',
                `OAuth 2.0 授權流程說明：

1. 點擊「開始授權」將開啟 Google 登入頁面
2. 選擇您的 Google 帳號
3. 允許應用程式存取 Google 相簿
4. 授權完成後會自動返回

⚠️ 注意事項：
• 需要在 Google Cloud Console 設定 OAuth 同意畫面
• 將此網址加入授權的重新導向 URI：
  ${redirectUri}

📋 完整的 OAuth 流程需要後端服務支援
   目前提供手動授權模式`,
                () => {
                    // 複製重新導向 URI
                    navigator.clipboard.writeText(redirectUri).then(() => {
                        showToast('success', '重新導向 URI 已複製！');
                    });
                    
                    // 標記為已設定（手動模式）
                    updateCredentialStatus('photos', true);
                    closeModal();
                }
            );
        }

        async function uploadToGooglePhotos() {
            // 檢查 Google 授權
            const token = getStoredGoogleToken();
            if (!token) {
                showToast('error', '請先授權 Google');
                showDocsHelp();
                return;
            }

            const canvas = document.getElementById('preview-canvas');
            const imageData = canvas.toDataURL('image/png');
            const zodiac = appState.generatedImages[appState.selectedResult]?.zodiac;
            const analysis = appState.currentAnalysis;
            const albumName = appState.credentials.photos?.albumName || '黃金聖衣收藏';

            showToast('info', '正在上傳至 Google 相簿...');

            try {
                // 生成帶浮水印的最終圖像
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = canvas.width;
                finalCanvas.height = canvas.height;
                const ctx = finalCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, 0);
                
                // 添加日期浮水印
                const date = new Date();
                const dateStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                ctx.font = 'bold 18px "Orbitron", monospace';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.textAlign = 'right';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                ctx.shadowBlur = 4;
                ctx.fillText(dateStr, finalCanvas.width - 15, finalCanvas.height - 15);

                const finalImageData = finalCanvas.toDataURL('image/png');
                const fileName = `${zodiac?.symbol || '⚜️'}_${zodiac?.name || '黃金聖衣'}_${Date.now()}.png`;

                // 將 base64 轉換為 Blob
                const base64Data = finalImageData.split(',')[1];
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const imageBlob = new Blob([bytes], { type: 'image/png' });

                // ========== Google Photos API 上傳流程 ==========
                
                // Step 1: 上傳圖片位元組，取得 uploadToken
                console.log('Step 1: 上傳圖片到 Google Photos...');
                const uploadResponse = await fetch(
                    'https://photoslibrary.googleapis.com/v1/uploads',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token.access_token,
                            'Content-Type': 'application/octet-stream',
                            'X-Goog-Upload-Content-Type': 'image/png',
                            'X-Goog-Upload-Protocol': 'raw'
                        },
                        body: imageBlob
                    }
                );

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    console.error('Upload error:', errorText);
                    throw new Error(`圖片上傳失敗: ${uploadResponse.status}`);
                }

                const uploadToken = await uploadResponse.text();
                console.log('Upload token obtained');

                // Step 2: 建立媒體項目
                console.log('Step 2: 建立媒體項目...');
                const description = `${zodiac?.symbol || '⚜️'} ${zodiac?.name || '黃金聖衣'}\n${analysis?.description || ''}\n📅 ${dateStr}`;
                
                const createResponse = await fetch(
                    'https://photoslibrary.googleapis.com/v1/mediaItems:batchCreate',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token.access_token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            newMediaItems: [{
                                description: description,
                                simpleMediaItem: {
                                    fileName: fileName,
                                    uploadToken: uploadToken
                                }
                            }]
                        })
                    }
                );

                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    console.error('Create error:', errorData);
                    throw new Error(errorData.error?.message || '建立媒體項目失敗');
                }

                const createResult = await createResponse.json();
                const newMediaItem = createResult.newMediaItemResults?.[0];
                
                if (newMediaItem?.status?.message && newMediaItem.status.message !== 'Success') {
                    throw new Error(newMediaItem.status.message);
                }

                const mediaItem = newMediaItem?.mediaItem;
                const photoUrl = mediaItem?.productUrl || 'https://photos.google.com/';
                
                console.log('Photo created:', mediaItem?.id);

                // Step 3: 加入相簿（優先使用已儲存的 albumId）
                let albumUrl = 'https://photos.google.com/';
                let savedAlbumId = appState.credentials.photos?.albumId || '';
                
                try {
                    let albumId = savedAlbumId;
                    
                    // 如果沒有已儲存的 albumId，則建立或尋找相簿
                    if (!albumId) {
                        console.log('沒有已儲存的相簿 ID，搜尋或建立相簿...');
                        albumId = await getOrCreatePhotosAlbum(token.access_token, albumName);
                        
                        // 自動儲存 albumId 到認證資料
                        if (albumId) {
                            console.log('儲存相簿 ID:', albumId);
                            document.getElementById('photos-album-id').value = albumId;
                            
                            // 更新 appState 和 IndexedDB
                            if (appState.credentials.photos) {
                                appState.credentials.photos.albumId = albumId;
                            } else {
                                appState.credentials.photos = { albumId: albumId, albumName: albumName };
                            }
                            await db.saveCredential('photos', appState.credentials.photos);
                            showToast('info', '📁 已記住相簿，下次上傳會到同一本');
                        }
                    } else {
                        console.log('使用已儲存的相簿 ID:', albumId);
                    }
                    
                    if (albumId && mediaItem?.id) {
                        await addPhotoToAlbum(token.access_token, albumId, mediaItem.id);
                        albumUrl = `https://photos.google.com/album/${albumId}`;
                        console.log('Added to album:', albumName, 'ID:', albumId);
                    }
                } catch (albumError) {
                    console.warn('無法加入相簿，但圖片已上傳:', albumError);
                }

                // 顯示成功彈窗
                showUploadSuccessModal('📷', 'Google 相簿上傳成功！', {
                    type: 'photos',
                    fileName: fileName,
                    folderName: albumName,
                    fileUrl: photoUrl,
                    folderUrl: albumUrl,
                    zodiac: zodiac,
                    dateStr: dateStr
                });

                // 發送 LINE 通知
                await sendLineNotifyViaGAS(`📷 圖片已上傳至 Google 相簿！

📁 相簿：${albumName}
⚜️ ${zodiac?.symbol || ''} ${zodiac?.name || '黃金聖衣'}
📄 ${fileName}
📅 ${dateStr}

🔗 ${photoUrl}`);

                // 儲存到歷史記錄
                await saveToHistory(finalImageData, zodiac);

            } catch (error) {
                console.error('Google Photos upload error:', error);
                
                if (error.message.includes('invalid_grant') || error.message.includes('Token') || error.message.includes('401')) {
                    showToast('error', '授權已過期，請重新授權 Google');
                    clearGoogleAuth();
                } else if (error.message.includes('403')) {
                    showToast('error', '權限不足，請重新授權並允許 Google Photos 存取');
                    clearGoogleAuth();
                } else {
                    showToast('error', '上傳失敗：' + error.message);
                }
            }
        }

        // 取得或建立 Google Photos 相簿
        async function getOrCreatePhotosAlbum(accessToken, albumName) {
            // 搜尋現有相簿
            const listResponse = await fetch(
                'https://photoslibrary.googleapis.com/v1/albums?pageSize=50',
                {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                }
            );

            if (listResponse.ok) {
                const listResult = await listResponse.json();
                const existingAlbum = listResult.albums?.find(a => a.title === albumName);
                if (existingAlbum) {
                    return existingAlbum.id;
                }
            }

            // 建立新相簿
            const createResponse = await fetch(
                'https://photoslibrary.googleapis.com/v1/albums',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        album: { title: albumName }
                    })
                }
            );

            if (createResponse.ok) {
                const createResult = await createResponse.json();
                return createResult.id;
            }

            return null;
        }

        // 將照片加入相簿
        async function addPhotoToAlbum(accessToken, albumId, mediaItemId) {
            await fetch(
                `https://photoslibrary.googleapis.com/v1/albums/${albumId}:batchAddMediaItems`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mediaItemIds: [mediaItemId]
                    })
                }
            );
        }

        // 取得或建立 Google Drive 資料夾（保留給 Docs 使用）
        async function getOrCreateFolder(accessToken, folderName) {
            // 搜尋現有資料夾
            const searchResponse = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(folderName)}' and mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id,name)`,
                {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                }
            );

            const searchResult = await searchResponse.json();

            if (searchResult.files && searchResult.files.length > 0) {
                return searchResult.files[0].id;
            }

            // 建立新資料夾
            const createResponse = await fetch(
                'https://www.googleapis.com/drive/v3/files',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder'
                    })
                }
            );

            const createResult = await createResponse.json();
            return createResult.id;
        }

        async function verifyLineBot() {
            const channelToken = document.getElementById('line-channel-token').value.trim();
            const gasUrl = document.getElementById('line-gas-url').value.trim();
            
            if (!channelToken) {
                showToast('error', '請輸入 Channel Access Token');
                return;
            }

            showToast('info', '驗證中...');

            // 如果有 GAS URL，透過 GAS 驗證
            if (gasUrl) {
                try {
                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify({
                            action: 'getBotInfo',
                            channelToken: channelToken
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success && result.botInfo) {
                        showToast('success', `✅ LINE Bot 驗證成功！\nBot: ${result.botInfo.displayName}`);
                        updateCredentialStatus('line', true);
                    } else {
                        showToast('error', 'Token 驗證失敗: ' + (result.error || ''));
                        updateCredentialStatus('line', false);
                    }
                } catch (error) {
                    showToast('error', 'GAS 連線失敗，請檢查網址');
                }
            } else {
                // 沒有 GAS，只做格式驗證
                if (channelToken.length > 100) {
                    showToast('success', 'Channel Token 格式正確\n💡 設定 GAS 網址可完整驗證');
                    updateCredentialStatus('line', true);
                } else {
                    showToast('error', 'Channel Token 格式不正確');
                }
            }
        }

        // ==================== 星空背景 ====================
        function initStarfield() {
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            
            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resize();
            window.addEventListener('resize', resize);

            const stars = [];
            for (let i = 0; i < 200; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5,
                    alpha: Math.random(),
                    speed: 0.01 + Math.random() * 0.03
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                stars.forEach(star => {
                    star.alpha += star.speed;
                    if (star.alpha > 1 || star.alpha < 0) star.speed *= -1;
                    
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                    ctx.fill();
                });

                requestAnimationFrame(animate);
            }
            animate();
        }

        // ==================== 星座選擇器 ====================
        function initZodiacGrid() {
            const grid = document.getElementById('zodiac-grid');
            grid.innerHTML = '';

            ZODIAC_DATA.forEach(zodiac => {
                const card = document.createElement('div');
                card.className = 'zodiac-card';
                card.dataset.zodiac = zodiac.id;
                card.onclick = () => selectZodiac(zodiac.id);
                
                card.innerHTML = `
                    <div class="card-content">
                        <div class="zodiac-icon">${zodiac.symbol}</div>
                        <div class="zodiac-name-zh">${zodiac.name}</div>
                        <div class="zodiac-name-en">${zodiac.nameEn.toUpperCase()}</div>
                    </div>
                    <div class="energy-bar">
                        <div class="energy-fill"></div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function selectZodiac(zodiacId) {
            document.querySelectorAll('.zodiac-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`[data-zodiac="${zodiacId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                appState.selectedZodiac = zodiacId;
                showToast('success', `已選擇 ${ZODIAC_DATA.find(z => z.id === zodiacId).name} 聖衣`);
            }
        }

        // ==================== 文件上傳 ====================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                appState.uploadedImage = e.target.result;
                const preview = document.getElementById('upload-preview');
                preview.src = e.target.result;
                document.getElementById('upload-zone').classList.add('has-image');
                document.getElementById('upload-actions').style.display = 'flex';
                showToast('success', '圖像上傳成功！選擇「直接編輯」或「套用黃金聖衣」');
            };
            reader.readAsDataURL(file);
        }

        // 套用黃金聖衣到上傳的圖片
        async function applyGoldCloth() {
            if (!appState.uploadedImage) {
                showToast('error', '請先上傳圖片');
                return;
            }

            if (!appState.selectedZodiac) {
                showToast('error', '請先選擇一個星座');
                return;
            }

            const apiKey = appState.credentials.gemini?.key;
            if (!apiKey) {
                showToast('error', '請先設定 Gemini API Key');
                return;
            }

            const zodiac = ZODIAC_DATA.find(z => z.id === appState.selectedZodiac);
            const styleMode = document.getElementById('style-mode').value;
            const aiModel = document.getElementById('ai-model').value;

            showToast('info', `正在為圖片套用 ${zodiac.name} 黃金聖衣...`);

            try {
                // 使用 Gemini 圖像編輯功能
                const clothDescription = CLOTH_DESCRIPTIONS[appState.selectedZodiac];
                const prompt = `Transform this person in the image to wear the ${zodiac.nameEn} Gold Cloth armor from Saint Seiya. 
                
Add the following armor elements: ${clothDescription}

Keep the person's face and body exactly the same, only add the golden armor on top. 
The armor should look majestic and powerful, with golden metallic shine.
Style: ${styleMode}
Maintain the original person's identity and features.`;

                // 取得圖片的 base64 數據
                const base64Data = appState.uploadedImage.split(',')[1];
                const mimeType = appState.uploadedImage.split(';')[0].split(':')[1];

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${aiModel}:generateContent`,
                    {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'x-goog-api-key': apiKey
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { 
                                        inlineData: { 
                                            mimeType: mimeType,
                                            data: base64Data
                                        }
                                    }
                                ]
                            }],
                            generationConfig: {
                                responseModalities: ['TEXT', 'IMAGE']
                            }
                        })
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || '圖像編輯失敗');
                }

                const data = await response.json();
                const candidates = data.candidates || [];
                
                if (candidates.length === 0) {
                    throw new Error('API 沒有返回結果');
                }

                const parts = candidates[0].content?.parts || [];
                let generatedImageUrl = null;

                for (const part of parts) {
                    if (part.inlineData && part.inlineData.data) {
                        const resultMimeType = part.inlineData.mimeType || 'image/png';
                        generatedImageUrl = `data:${resultMimeType};base64,${part.inlineData.data}`;
                        break;
                    }
                }

                if (!generatedImageUrl) {
                    throw new Error('API 沒有返回圖像');
                }

                // 設定為已生成的圖像
                appState.generatedImages = [{
                    url: generatedImageUrl,
                    zodiac: zodiac,
                    isAIGenerated: true,
                    isEdited: true
                }];
                appState.selectedResult = 0;

                // 開啟編輯器
                openEditor();
                showToast('success', `🎉 ${zodiac.name} 黃金聖衣套用成功！`);

            } catch (error) {
                console.error('套用聖衣失敗:', error);
                showToast('error', '套用失敗：' + error.message);
            }
        }

        // 直接編輯上傳的圖片
        function editUploadedImage() {
            if (!appState.uploadedImage) {
                showToast('error', '請先上傳圖片');
                return;
            }

            // 取得選擇的星座（如果有的話）
            const selectedZodiac = appState.selectedZodiac 
                ? ZODIAC_DATA.find(z => z.id === appState.selectedZodiac)
                : ZODIAC_DATA[0]; // 預設白羊座

            // 設定為已生成的圖像
            appState.generatedImages = [{
                url: appState.uploadedImage,
                zodiac: selectedZodiac,
                isUploaded: true
            }];
            appState.selectedResult = 0;

            // 直接開啟編輯器
            openEditor();

            // 觸發 AI 分析
            analyzeImage();

            showToast('success', '已載入圖片，可以開始編輯！');
        }

        // 拖放支援
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化 Google API
            initGoogleAPI();
            
            const uploadZone = document.getElementById('upload-zone');
            if (uploadZone) {
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = 'var(--gold-primary)';
                });
                
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.style.borderColor = '';
                });
                
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        document.getElementById('file-input').files = dataTransfer.files;
                        handleFileUpload({ target: { files: [file] } });
                    }
                });
            }
        });

        // ==================== 圖像生成 ====================
        async function startGeneration() {
            if (!appState.credentials.gemini) {
                showToast('error', '請先設定並儲存 Gemini API Key');
                return;
            }

            if (!appState.selectedZodiac) {
                showToast('error', '請選擇一個星座');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            const progressDiv = document.getElementById('generation-progress');
            
            generateBtn.disabled = true;
            progressDiv.classList.add('active');

            const statusMessages = [
                '正在喚醒小宇宙...',
                '連結星座能量...',
                '召喚黃金聖衣...',
                '注入宇宙力量...',
                '完成圖像生成！'
            ];

            let currentStep = 0;
            const statusInterval = setInterval(() => {
                if (currentStep < statusMessages.length - 1) {
                    document.getElementById('progress-status').textContent = statusMessages[currentStep];
                    currentStep++;
                }
            }, 2000);

            try {
                const results = await generateImages(4);
                
                clearInterval(statusInterval);
                document.getElementById('progress-status').textContent = statusMessages[statusMessages.length - 1];

                setTimeout(() => {
                    progressDiv.classList.remove('active');
                    generateBtn.disabled = false;
                    displayResults(results);
                }, 1000);

            } catch (error) {
                clearInterval(statusInterval);
                progressDiv.classList.remove('active');
                generateBtn.disabled = false;
                showToast('error', '生成失敗: ' + error.message);
            }
        }

        async function generateImages(count) {
            const zodiac = ZODIAC_DATA.find(z => z.id === appState.selectedZodiac);
            const styleMode = document.getElementById('style-mode').value;
            const bgSetting = document.getElementById('bg-setting').value;
            const aiModel = document.getElementById('ai-model').value;
            const consistency = document.getElementById('character-consistency').value;
            
            // 20 種風格提示詞
            const stylePrompts = {
                chibi: 'chibi cute style, super deformed, big head small body, adorable kawaii',
                anime: 'anime style, dynamic pose, detailed shading, Japanese animation, cel shaded',
                realistic: 'realistic style, highly detailed, cinematic lighting, photorealistic, 8K',
                pixel: 'pixel art style, 16-bit retro game aesthetic, pixelated, sprite art',
                watercolor: 'watercolor painting style, soft colors, flowing brushstrokes, artistic',
                oil: 'oil painting style, rich textures, classical art, museum quality, masterpiece',
                cyberpunk: 'cyberpunk style, neon lights, futuristic, glowing effects, high tech',
                steampunk: 'steampunk style, brass and copper, Victorian era, mechanical gears, vintage',
                ink: 'Chinese ink wash painting style, sumi-e, black and white, elegant brushwork',
                comic: 'American comic book style, bold lines, dramatic shading, superhero art, Marvel DC style',
                '3d': '3D rendered, CGI quality, Pixar style, smooth shading, professional rendering',
                gold: 'pure gold sculpture, metallic golden statue, shiny reflective surface, luxury art',
                fantasy: 'fantasy art style, magical elements, ethereal glow, mystical atmosphere, enchanted',
                gothic: 'gothic dark style, dramatic shadows, mysterious atmosphere, cathedral aesthetics',
                pop: 'pop art style, bold colors, halftone dots, Andy Warhol inspired, vibrant',
                sketch: 'pencil sketch style, hand-drawn, detailed linework, artistic hatching',
                neon: 'neon glow style, vibrant glowing lights, dark background, electric colors',
                vintage: 'vintage retro style, aged film look, nostalgic colors, classic aesthetic',
                minimalist: 'minimalist style, clean lines, simple forms, elegant negative space',
                baroque: 'baroque style, ornate details, dramatic lighting, opulent grandeur, classical'
            };
            
            const stylePrompt = stylePrompts[styleMode] || stylePrompts.anime;

            // 20 種背景提示詞
            const bgPrompts = {
                white: 'pure white background, clean isolated',
                transparent: 'simple dark background',
                cosmos: 'cosmic starfield background with nebula and galaxies',
                temple: 'Greek temple Sanctuary of Athena background',
                galaxy: 'swirling galaxy spiral background with stars',
                aurora: 'northern lights aurora borealis colorful sky',
                fire: 'blazing fire flames background, inferno',
                ice: 'frozen ice crystal background, winter wonderland',
                forest: 'mystical enchanted forest background, magical trees',
                ocean: 'deep underwater ocean background with light rays',
                mountain: 'majestic snow-capped mountain peaks background',
                sunset: 'beautiful sunset sky with orange and purple clouds',
                lightning: 'dramatic lightning storm thunderstorm background',
                cherry: 'cherry blossom sakura petals floating background',
                ruins: 'ancient stone ruins temple background, mysterious',
                palace: 'golden ornate palace interior background, luxurious',
                volcano: 'volcanic eruption with flowing lava background',
                cloud: 'heavenly clouds paradise sky background',
                night: 'starry night sky with crescent moon background',
                rainbow: 'rainbow light rays colorful background'
            };
            let bgPrompt = bgPrompts[bgSetting] || bgPrompts.cosmos;

            // 人物一致性提示詞
            let consistencyPrompt = '';
            if (consistency >= 80) {
                consistencyPrompt = 'IMPORTANT: maintain exact same character face, body proportions, and features across all images. Same person, same identity, highly consistent character design.';
            } else if (consistency >= 60) {
                consistencyPrompt = 'maintain consistent character appearance, similar facial features and body type.';
            } else if (consistency >= 40) {
                consistencyPrompt = 'keep general character style consistent.';
            } else {
                consistencyPrompt = 'creative artistic interpretation allowed.';
            }

            const basePrompt = CLOTH_DESCRIPTIONS[appState.selectedZodiac];
            
            // 完整的圖像生成提示詞（加入人物一致性）
            const fullPrompt = `${basePrompt}. ${stylePrompt}. ${bgPrompt}. ${consistencyPrompt} Saint Seiya Gold Cloth armor, golden metallic armor with intricate details, high quality masterpiece illustration. The armor should be displayed elegantly, showing the full armor design clearly.`;

            document.getElementById('progress-detail').textContent = `正在使用 ${aiModel.includes('imagen') ? 'Imagen 3' : 'Gemini'} 生成 ${zodiac.name} 黃金聖衣...`;

            const results = [];
            const apiKey = appState.credentials.gemini?.key;
            
            for (let i = 0; i < count; i++) {
                document.getElementById('progress-detail').textContent = `正在生成第 ${i + 1}/${count} 張圖像...`;
                
                try {
                    let imageUrl;
                    
                    if (aiModel.includes('imagen')) {
                        // 使用 Imagen 3
                        imageUrl = await generateWithImagen(fullPrompt, apiKey, i);
                    } else {
                        // 使用 Gemini 2.5 Flash
                        imageUrl = await generateWithGemini(fullPrompt, apiKey, i, aiModel);
                    }
                    
                    results.push({
                        id: Date.now() + i,
                        url: imageUrl,
                        prompt: fullPrompt,
                        zodiac: zodiac,
                        isAIGenerated: true,
                        model: aiModel
                    });
                    
                } catch (error) {
                    console.error(`生成第 ${i + 1} 張圖像失敗:`, error);
                    
                    // 顯示具體錯誤
                    document.getElementById('progress-detail').textContent = `第 ${i + 1} 張失敗: ${error.message.substring(0, 50)}...`;
                    
                    // 如果 AI 生成失敗，使用佔位符
                    results.push({
                        id: Date.now() + i,
                        url: await generatePlaceholderImage(zodiac, i),
                        prompt: fullPrompt,
                        zodiac: zodiac,
                        isAIGenerated: false,
                        error: error.message
                    });
                }
                
                // 稍微延遲避免 API 限制
                if (i < count - 1) {
                    await new Promise(r => setTimeout(r, 1000));
                }
            }

            return results;
        }

        // ==================== Gemini 2.5 Flash 圖像生成 ====================
        async function generateWithGemini(prompt, apiKey, variation, model) {
            if (!apiKey) {
                throw new Error('請先設定 Gemini API Key');
            }

            // 加入變體提示
            const variedPrompt = `Generate an image: ${prompt} (Variation ${variation + 1})`;

            // 使用指定的 Gemini 模型（API Key 放在 header）
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`,
                {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: variedPrompt }]
                        }],
                        generationConfig: {
                            responseModalities: ['TEXT', 'IMAGE']
                        }
                    })
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API 錯誤: ${response.status}`);
            }

            const data = await response.json();
            
            // 解析回應，找到圖像數據
            const candidates = data.candidates || [];
            if (candidates.length === 0) {
                throw new Error('API 沒有返回結果');
            }

            const parts = candidates[0].content?.parts || [];
            
            // 尋找圖像部分
            for (const part of parts) {
                if (part.inlineData && part.inlineData.data) {
                    const mimeType = part.inlineData.mimeType || 'image/png';
                    return `data:${mimeType};base64,${part.inlineData.data}`;
                }
            }

            // 如果沒有圖像，拋出錯誤
            throw new Error('API 沒有返回圖像，請確認 API Key 有圖像生成權限');
        }

        // ==================== Imagen 4 圖像生成 ====================
        async function generateWithImagen(prompt, apiKey, variation) {
            if (!apiKey) {
                throw new Error('請先設定 Gemini API Key');
            }

            // 取得選擇的模型
            const aiModel = document.getElementById('ai-model').value;

            // 加入變體提示
            const variedPrompt = `${prompt} (artistic variation ${variation + 1})`;

            // 使用 Imagen 模型（predict 端點）
            // API Key 放在 header 中（官方文檔格式）
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${aiModel}:predict`,
                {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey
                    },
                    body: JSON.stringify({
                        instances: [
                            { prompt: variedPrompt }
                        ],
                        parameters: {
                            sampleCount: 1
                        }
                    })
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                const errorMsg = errorData.error?.message || `Imagen API 錯誤: ${response.status}`;
                throw new Error(errorMsg);
            }

            const data = await response.json();
            
            // 解析 Imagen 回應
            const predictions = data.predictions || [];
            if (predictions.length === 0) {
                throw new Error('Imagen API 沒有返回圖像');
            }

            // 取得第一張圖像
            const imageBytes = predictions[0].bytesBase64Encoded;
            if (imageBytes) {
                return `data:image/png;base64,${imageBytes}`;
            }

            throw new Error('無法解析 Imagen 回應');
        }

        async function generatePlaceholderImage(zodiac, variation) {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            // 背景漸層
            const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 360);
            gradient.addColorStop(0, '#2a2a4a');
            gradient.addColorStop(1, '#0a0a12');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 512, 512);

            // 裝飾環
            ctx.strokeStyle = 'rgba(155, 89, 182, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(256, 256, 200, 0, Math.PI * 2);
            ctx.stroke();

            // 繪製星座符號
            ctx.font = 'bold 180px serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            ctx.shadowColor = '#FFD700';
            ctx.shadowBlur = 40;
            ctx.fillStyle = '#FFD700';
            ctx.fillText(zodiac.symbol, 256, 220);

            // 名稱
            ctx.shadowBlur = 20;
            ctx.font = 'bold 36px "Noto Sans TC", sans-serif';
            ctx.fillText(zodiac.name, 256, 350);

            ctx.font = '20px "Cinzel", serif';
            ctx.fillStyle = '#9B59B6';
            ctx.shadowColor = '#9B59B6';
            ctx.fillText('GOLD CLOTH', 256, 400);

            // 變體標記
            ctx.font = '14px "Orbitron", sans-serif';
            ctx.fillStyle = '#666';
            ctx.shadowBlur = 0;
            ctx.fillText(`Variation ${variation + 1}`, 256, 480);

            return canvas.toDataURL('image/png');
        }

        // ==================== 結果展示 ====================
        function displayResults(results) {
            appState.generatedImages = results;
            
            const resultsSection = document.getElementById('results-section');
            const resultsGrid = document.getElementById('results-grid');
            
            resultsGrid.innerHTML = '';
            
            let aiCount = 0;
            let placeholderCount = 0;
            let firstError = null;
            
            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.dataset.index = index;
                card.onclick = () => selectResult(index);
                
                // 判斷是否為 AI 生成
                const isAI = result.isAIGenerated;
                if (isAI) aiCount++;
                else {
                    placeholderCount++;
                    if (!firstError && result.error) firstError = result.error;
                }
                
                const badgeClass = isAI ? 'ai-badge' : 'placeholder-badge';
                const badgeText = isAI ? '🤖 AI' : '📷 佔位';
                
                card.innerHTML = `
                    <img class="result-image" src="${result.url}" alt="Generated ${index + 1}">
                    <div class="result-badge">方案 ${index + 1}</div>
                    <div class="result-type-badge ${badgeClass}">${badgeText}</div>
                    <button class="result-select-btn" onclick="event.stopPropagation(); selectResult(${index}); openEditor();">
                        選擇此圖
                    </button>
                `;
                
                resultsGrid.appendChild(card);
            });

            resultsSection.classList.add('active');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            // 顯示結果統計
            if (aiCount === results.length) {
                showToast('success', `🎉 已成功生成 ${aiCount} 張 AI 圖像！`);
            } else if (aiCount > 0) {
                showToast('info', `生成完成：${aiCount} 張 AI 圖像，${placeholderCount} 張佔位圖`);
            } else {
                // 顯示詳細錯誤
                const errorMsg = firstError ? firstError.substring(0, 80) : '請確認 API Key 有圖像生成權限';
                showToast('error', `⚠️ AI 生成失敗：${errorMsg}`);
                
                // 顯示說明彈窗
                showModal(
                    '⚠️',
                    'AI 圖像生成失敗',
                    `錯誤訊息：${firstError || '未知錯誤'}

可能的原因：
1️⃣ API Key 沒有圖像生成權限
2️⃣ 模型暫時不可用
3️⃣ 請求過於頻繁

建議：
• 在 Google AI Studio 測試圖像生成
• 嘗試切換不同的 AI 模型
• 稍後再試

目前顯示的是佔位圖，你可以：
• 上傳自己的圖片進行編輯
• 使用 AI 解析功能分析圖片`,
                    () => { closeModal(); }
                );
            }
        }

        function selectResult(index) {
            document.querySelectorAll('.result-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.querySelector(`[data-index="${index}"]`).classList.add('selected');
            appState.selectedResult = index;
        }

        // ==================== AI 圖像解析 ====================
        async function analyzeImageWithAI(imageData) {
            const analysisPanel = document.getElementById('ai-analysis-panel');
            const loadingDiv = document.getElementById('analysis-loading');
            const contentDiv = document.getElementById('analysis-content');
            
            analysisPanel.classList.add('active');
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';

            // 檢查快取
            const imageHash = await hashString(imageData.substring(0, 1000));
            const cached = await db.getAnalysisCache(imageHash);
            
            if (cached) {
                displayAnalysis(cached.analysis, imageData);
                return;
            }

            // 呼叫 Gemini Vision API
            if (!appState.credentials.gemini) {
                showToast('error', '需要 Gemini API 才能進行 AI 解析');
                loadingDiv.style.display = 'none';
                return;
            }

            try {
                const analysis = await callGeminiVision(imageData);
                await db.saveAnalysisCache(imageHash, analysis);
                displayAnalysis(analysis, imageData);
            } catch (error) {
                // 使用模擬資料
                const mockAnalysis = generateMockAnalysis();
                displayAnalysis(mockAnalysis, imageData);
            }
        }

        async function callGeminiVision(imageData) {
            const apiKey = appState.credentials.gemini.key;
            const base64Image = imageData.split(',')[1];

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            {
                                text: `請分析這張黃金聖衣圖像，並以 JSON 格式回覆：
                                {
                                    "description": "圖像的詳細描述（繁體中文，100字以內）",
                                    "features": "聖衣的特徵描述（繁體中文，80字以內）",
                                    "style": "藝術風格分析（繁體中文，60字以內）",
                                    "tags": ["標籤1", "標籤2", "標籤3", "標籤4", "標籤5"]
                                }`
                            },
                            {
                                inline_data: {
                                    mime_type: "image/png",
                                    data: base64Image
                                }
                            }
                        ]
                    }]
                })
            });

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            // 解析 JSON
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
            
            throw new Error('無法解析回應');
        }

        function generateMockAnalysis() {
            const zodiac = ZODIAC_DATA.find(z => z.id === appState.selectedZodiac);
            return {
                description: `這是一張${zodiac.name}黃金聖衣的精美插圖。圖中展現了聖鬥士的威嚴姿態，黃金聖衣閃耀著神聖的光芒，充分體現了${zodiac.nameEn}星座的力量與特質。`,
                features: `${zodiac.name}聖衣具有獨特的設計元素，包括精緻的肩甲、胸甲和護臂。聖衣整體呈現黃金色澤，邊緣帶有星座符號的裝飾紋路。`,
                style: `採用日式動漫風格繪製，線條流暢，色彩飽和。光影效果處理細膩，營造出神聖莊嚴的氛圍。`,
                tags: [zodiac.name, '黃金聖衣', '聖鬥士星矢', '動漫風格', 'Q版']
            };
        }

        function displayAnalysis(analysis, imageData) {
            const loadingDiv = document.getElementById('analysis-loading');
            const contentDiv = document.getElementById('analysis-content');
            
            document.getElementById('analysis-image').src = imageData;
            document.getElementById('analysis-description').textContent = analysis.description;
            document.getElementById('analysis-features').textContent = analysis.features;
            document.getElementById('analysis-style').textContent = analysis.style;
            
            const tagsContainer = document.getElementById('analysis-tags');
            tagsContainer.innerHTML = '';
            analysis.tags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'analysis-tag';
                tagEl.textContent = tag;
                tagsContainer.appendChild(tagEl);
            });

            appState.currentAnalysis = analysis;
            
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'grid';
        }

        async function hashString(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ==================== 編輯器 ====================
        function openEditor() {
            if (appState.selectedResult === null) {
                showToast('error', '請先選擇一張圖像');
                return;
            }

            const editorPanel = document.getElementById('editor-panel');
            editorPanel.classList.add('active');
            editorPanel.scrollIntoView({ behavior: 'smooth' });
            
            updatePreview();
            
            // 觸發 AI 解析
            const selectedImage = appState.generatedImages[appState.selectedResult];
            if (selectedImage) {
                analyzeImageWithAI(selectedImage.url);
            }
        }

        function selectFrame(frameType) {
            document.querySelectorAll('.frame-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-frame="${frameType}"]`).classList.add('selected');
            appState.currentFrame = frameType;
            updatePreview();
        }

        function selectFilter(filterType) {
            document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-filter="${filterType}"]`).classList.add('selected');
            appState.currentFilter = filterType;
            updatePreview();
        }

        function updatePreview() {
            const canvas = document.getElementById('preview-canvas');
            const ctx = canvas.getContext('2d');
            
            const selectedImage = appState.generatedImages[appState.selectedResult];
            if (!selectedImage) return;

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                ctx.filter = getFilterStyle(appState.currentFilter);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                ctx.filter = 'none';

                drawFrame(ctx, appState.currentFrame);
                drawWatermarks(ctx, selectedImage.zodiac);
            };
            img.onerror = () => {
                // 如果載入失敗，嘗試不用 crossOrigin
                const img2 = new Image();
                img2.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.filter = getFilterStyle(appState.currentFilter);
                    ctx.drawImage(img2, 0, 0, canvas.width, canvas.height);
                    ctx.filter = 'none';
                    drawFrame(ctx, appState.currentFrame);
                    drawWatermarks(ctx, selectedImage.zodiac);
                };
                img2.src = selectedImage.url;
            };
            img.src = selectedImage.url;
        }

        function getFilterStyle(filter) {
            switch (filter) {
                case 'golden': return 'sepia(30%) saturate(150%) brightness(110%)';
                case 'cosmos': return 'hue-rotate(30deg) saturate(130%) contrast(110%)';
                case 'vintage': return 'sepia(50%) contrast(90%) brightness(90%)';
                case 'warm': return 'sepia(20%) saturate(120%) brightness(105%)';
                case 'cool': return 'hue-rotate(180deg) saturate(80%) brightness(100%)';
                case 'sepia': return 'sepia(80%) contrast(95%)';
                case 'bw': return 'grayscale(100%) contrast(110%)';
                case 'neon': return 'saturate(200%) contrast(130%) brightness(110%)';
                case 'sunset': return 'sepia(30%) hue-rotate(-20deg) saturate(140%) brightness(105%)';
                case 'ocean': return 'hue-rotate(200deg) saturate(120%) brightness(95%)';
                case 'forest': return 'hue-rotate(80deg) saturate(90%) brightness(95%)';
                case 'fire': return 'sepia(50%) hue-rotate(-30deg) saturate(180%) contrast(110%)';
                case 'ice': return 'hue-rotate(180deg) saturate(70%) brightness(110%) contrast(95%)';
                case 'dream': return 'blur(1px) saturate(130%) brightness(105%)';
                case 'pop': return 'saturate(250%) contrast(120%) brightness(100%)';
                case 'dramatic': return 'contrast(150%) saturate(110%) brightness(90%)';
                case 'soft': return 'contrast(90%) brightness(105%) saturate(90%)';
                case 'sharp': return 'contrast(130%) saturate(110%) brightness(100%)';
                case 'aurora': return 'hue-rotate(60deg) saturate(150%) brightness(105%)';
                default: return 'none';
            }
        }

        function drawFrame(ctx, frame) {
            const w = ctx.canvas.width;
            const h = ctx.canvas.height;
            const borderWidth = 20;

            ctx.save();
            
            switch (frame) {
                case 'gold':
                    const goldGradient = ctx.createLinearGradient(0, 0, w, h);
                    goldGradient.addColorStop(0, '#FFD700');
                    goldGradient.addColorStop(0.5, '#FFF8DC');
                    goldGradient.addColorStop(1, '#B8860B');
                    ctx.strokeStyle = goldGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;
                    
                case 'cosmos':
                    ctx.strokeStyle = '#9B59B6';
                    ctx.lineWidth = borderWidth;
                    ctx.setLineDash([10, 5]);
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.setLineDash([]);
                    break;
                    
                case 'fire':
                    const fireGradient = ctx.createLinearGradient(0, h, 0, 0);
                    fireGradient.addColorStop(0, '#FF6B6B');
                    fireGradient.addColorStop(0.5, '#FFE66D');
                    fireGradient.addColorStop(1, '#FF9F43');
                    ctx.strokeStyle = fireGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;
                    
                case 'ice':
                    const iceGradient = ctx.createLinearGradient(0, 0, w, h);
                    iceGradient.addColorStop(0, '#00CEC9');
                    iceGradient.addColorStop(0.5, '#81ECEC');
                    iceGradient.addColorStop(1, '#74B9FF');
                    ctx.strokeStyle = iceGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;
                    
                case 'lightning':
                    ctx.strokeStyle = '#FFE66D';
                    ctx.lineWidth = borderWidth;
                    ctx.shadowColor = '#FFE66D';
                    ctx.shadowBlur = 20;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.shadowBlur = 0;
                    break;

                case 'rainbow':
                    const rainbowGradient = ctx.createLinearGradient(0, 0, w, h);
                    rainbowGradient.addColorStop(0, '#FF0000');
                    rainbowGradient.addColorStop(0.17, '#FF7F00');
                    rainbowGradient.addColorStop(0.33, '#FFFF00');
                    rainbowGradient.addColorStop(0.5, '#00FF00');
                    rainbowGradient.addColorStop(0.67, '#0000FF');
                    rainbowGradient.addColorStop(0.83, '#4B0082');
                    rainbowGradient.addColorStop(1, '#9400D3');
                    ctx.strokeStyle = rainbowGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;

                case 'star':
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = borderWidth;
                    ctx.setLineDash([15, 10, 5, 10]);
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.setLineDash([]);
                    break;

                case 'heart':
                    const heartGradient = ctx.createLinearGradient(0, 0, w, h);
                    heartGradient.addColorStop(0, '#FF69B4');
                    heartGradient.addColorStop(0.5, '#FF1493');
                    heartGradient.addColorStop(1, '#DC143C');
                    ctx.strokeStyle = heartGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;

                case 'diamond':
                    const diamondGradient = ctx.createLinearGradient(0, 0, w, h);
                    diamondGradient.addColorStop(0, '#B9F2FF');
                    diamondGradient.addColorStop(0.5, '#FFFFFF');
                    diamondGradient.addColorStop(1, '#E0FFFF');
                    ctx.strokeStyle = diamondGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.shadowColor = '#00FFFF';
                    ctx.shadowBlur = 15;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.shadowBlur = 0;
                    break;

                case 'crown':
                    const crownGradient = ctx.createLinearGradient(0, 0, w, h);
                    crownGradient.addColorStop(0, '#FFD700');
                    crownGradient.addColorStop(0.3, '#FFA500');
                    crownGradient.addColorStop(0.6, '#FFD700');
                    crownGradient.addColorStop(1, '#B8860B');
                    ctx.strokeStyle = crownGradient;
                    ctx.lineWidth = borderWidth + 5;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;

                case 'dragon':
                    const dragonGradient = ctx.createLinearGradient(0, 0, w, h);
                    dragonGradient.addColorStop(0, '#228B22');
                    dragonGradient.addColorStop(0.5, '#FFD700');
                    dragonGradient.addColorStop(1, '#FF4500');
                    ctx.strokeStyle = dragonGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;

                case 'phoenix':
                    const phoenixGradient = ctx.createLinearGradient(0, h, 0, 0);
                    phoenixGradient.addColorStop(0, '#FF4500');
                    phoenixGradient.addColorStop(0.5, '#FFD700');
                    phoenixGradient.addColorStop(1, '#FF6347');
                    ctx.strokeStyle = phoenixGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.shadowColor = '#FF4500';
                    ctx.shadowBlur = 20;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.shadowBlur = 0;
                    break;

                case 'sakura':
                    const sakuraGradient = ctx.createLinearGradient(0, 0, w, h);
                    sakuraGradient.addColorStop(0, '#FFB7C5');
                    sakuraGradient.addColorStop(0.5, '#FFC0CB');
                    sakuraGradient.addColorStop(1, '#FF69B4');
                    ctx.strokeStyle = sakuraGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;

                case 'ocean':
                    const oceanGradient = ctx.createLinearGradient(0, 0, 0, h);
                    oceanGradient.addColorStop(0, '#0077BE');
                    oceanGradient.addColorStop(0.5, '#00CED1');
                    oceanGradient.addColorStop(1, '#006994');
                    ctx.strokeStyle = oceanGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;

                case 'night':
                    ctx.strokeStyle = '#191970';
                    ctx.lineWidth = borderWidth;
                    ctx.shadowColor = '#4169E1';
                    ctx.shadowBlur = 15;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.shadowBlur = 0;
                    break;

                case 'sun':
                    const sunGradient = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w);
                    sunGradient.addColorStop(0, '#FFD700');
                    sunGradient.addColorStop(0.5, '#FFA500');
                    sunGradient.addColorStop(1, '#FF4500');
                    ctx.strokeStyle = sunGradient;
                    ctx.lineWidth = borderWidth;
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 25;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.shadowBlur = 0;
                    break;

                case 'celtic':
                    ctx.strokeStyle = '#228B22';
                    ctx.lineWidth = borderWidth;
                    ctx.setLineDash([20, 5, 5, 5]);
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.setLineDash([]);
                    break;

                case 'baroque':
                    const baroqueGradient = ctx.createLinearGradient(0, 0, w, h);
                    baroqueGradient.addColorStop(0, '#8B4513');
                    baroqueGradient.addColorStop(0.3, '#DAA520');
                    baroqueGradient.addColorStop(0.6, '#8B4513');
                    baroqueGradient.addColorStop(1, '#DAA520');
                    ctx.strokeStyle = baroqueGradient;
                    ctx.lineWidth = borderWidth + 8;
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    break;

                case 'tech':
                    ctx.strokeStyle = '#00FF00';
                    ctx.lineWidth = borderWidth;
                    ctx.shadowColor = '#00FF00';
                    ctx.shadowBlur = 10;
                    ctx.setLineDash([20, 10]);
                    ctx.strokeRect(borderWidth/2, borderWidth/2, w - borderWidth, h - borderWidth);
                    ctx.setLineDash([]);
                    ctx.shadowBlur = 0;
                    break;
            }
            
            ctx.restore();
        }

        function drawWatermarks(ctx, zodiac) {
            const w = ctx.canvas.width;
            const h = ctx.canvas.height;

            ctx.save();
            
            if (document.getElementById('wm-date').checked) {
                const date = new Date();
                const dateStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                
                ctx.font = '16px "Orbitron", monospace';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.textAlign = 'right';
                ctx.fillText(dateStr, w - 20, h - 20);
            }

            if (document.getElementById('wm-zodiac').checked && zodiac) {
                ctx.font = '24px serif';
                ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                ctx.textAlign = 'left';
                ctx.fillText(zodiac.symbol + ' ' + zodiac.name, 20, h - 20);
            }

            if (document.getElementById('wm-logo').checked) {
                ctx.font = 'bold 14px "Cinzel", serif';
                ctx.fillStyle = 'rgba(155, 89, 182, 0.6)';
                ctx.textAlign = 'center';
                ctx.fillText('GOLD CLOTH GENERATOR V2', w / 2, 30);
            }

            ctx.restore();
        }

        // ==================== 輸出功能 ====================
        async function downloadImage() {
            const canvas = document.getElementById('preview-canvas');
            const zodiac = appState.generatedImages[appState.selectedResult]?.zodiac;
            const filename = `gold-cloth-${zodiac?.id || 'image'}-${Date.now()}.png`;
            const dateStr = new Date().toLocaleString('zh-TW');
            
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();

            // 儲存到 IndexedDB
            await saveToHistory(canvas.toDataURL('image/png'), zodiac);
            
            showToast('success', '圖像已下載並儲存！');

            // 發送 LINE 通知
            await sendLineNotifyViaGAS(`💾 圖像已下載！\n\n⚜️ ${zodiac?.symbol || ''} ${zodiac?.name || '黃金聖衣'}\n📄 ${filename}\n📅 ${dateStr}`);
        }

        // 通用 LINE 通知函數（透過 GAS）
        async function sendLineNotifyViaGAS(message) {
            const gasUrl = appState.credentials.google?.gasUrl || appState.credentials.line?.gasUrl;
            const lineToken = appState.credentials.line?.channelToken;
            const lineUserId = appState.credentials.line?.userId;

            if (!gasUrl || !lineToken || !lineUserId) {
                return; // 沒有設定就不發送
            }

            try {
                await fetch(gasUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'pushMessage',
                        channelToken: lineToken,
                        userId: lineUserId,
                        message: message
                    })
                });
            } catch (error) {
                console.log('LINE 通知發送失敗:', error);
            }
        }

        async function saveToHistory(imageData, zodiac) {
            try {
                await db.saveHistory({
                    image: imageData,
                    zodiac: zodiac?.name || '未知',
                    zodiacId: zodiac?.id || 'unknown',
                    analysis: appState.currentAnalysis,
                    settings: {
                        frame: appState.currentFrame,
                        filter: appState.currentFilter
                    }
                });
                updateHistoryStats();
            } catch (error) {
                console.error('儲存歷史失敗:', error);
            }
        }

        async function uploadToGoogleDocs() {
            // 檢查 Google 授權
            const token = getStoredGoogleToken();
            if (!token) {
                showToast('error', '請先授權 Google');
                showDocsHelp();
                return;
            }

            // 檢查 token 是否過期
            if (token.expires_at && Date.now() > token.expires_at) {
                showToast('error', '授權已過期，請重新授權');
                clearGoogleAuth();
                return;
            }

            // 取得用戶提供的圖鑑連結
            const docUrlInput = document.getElementById('google-doc-url').value.trim();
            if (!docUrlInput) {
                showToast('error', '請先在認證管理區填入圖鑑文件連結');
                return;
            }

            // 從連結中提取 Document ID
            const docIdMatch = docUrlInput.match(/\/document\/d\/([a-zA-Z0-9_-]+)/);
            if (!docIdMatch) {
                showToast('error', '無效的 Google Doc 連結');
                return;
            }
            const docId = docIdMatch[1];

            const canvas = document.getElementById('preview-canvas');
            const imageData = canvas.toDataURL('image/png');
            const zodiac = appState.generatedImages[appState.selectedResult]?.zodiac;
            const analysis = appState.currentAnalysis;
            const dateStr = new Date().toLocaleString('zh-TW');

            showToast('info', '正在上傳圖片...');

            try {
                // Step 1: 先上傳圖片到 Google Drive
                console.log('Step 1: 上傳圖片到 Drive...');
                
                // 將 base64 轉換為 Blob
                const base64Data = imageData.split(',')[1];
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const imageBlob = new Blob([bytes], { type: 'image/png' });
                
                const imageFileName = `${zodiac?.name || '黃金聖衣'}_${Date.now()}.png`;
                
                const imageMetadata = {
                    name: imageFileName,
                    mimeType: 'image/png'
                };

                const imageFormData = new FormData();
                imageFormData.append('metadata', new Blob([JSON.stringify(imageMetadata)], { type: 'application/json' }));
                imageFormData.append('file', imageBlob);

                const imageUploadResponse = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webContentLink,webViewLink',
                    {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token.access_token },
                        body: imageFormData
                    }
                );

                if (!imageUploadResponse.ok) {
                    const errorText = await imageUploadResponse.text();
                    console.error('圖片上傳錯誤:', errorText);
                    throw new Error(`圖片上傳失敗 (${imageUploadResponse.status})`);
                }

                const imageFile = await imageUploadResponse.json();
                const imageId = imageFile.id;
                console.log('圖片上傳成功, ID:', imageId);

                // Step 2: 設定圖片為公開可讀
                await fetch(`https://www.googleapis.com/drive/v3/files/${imageId}/permissions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token.access_token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: 'reader', type: 'anyone' })
                });

                const imageUrl = `https://drive.google.com/uc?export=view&id=${imageId}`;
                console.log('圖片URL:', imageUrl);

                showToast('info', '正在追加到圖鑑...');

                // Step 3: 取得文件內容以獲得末尾位置
                console.log('Step 3: 取得文件資訊...');
                const docResponse = await fetch(
                    `https://docs.googleapis.com/v1/documents/${docId}`,
                    {
                        headers: { 'Authorization': 'Bearer ' + token.access_token }
                    }
                );
                
                if (!docResponse.ok) {
                    throw new Error('無法存取該文件，請確認您有編輯權限');
                }
                
                const docData = await docResponse.json();
                const docTitle = docData.title || '圖鑑';
                const endIndex = docData.body?.content?.slice(-1)[0]?.endIndex || 1;
                
                // 計算條目編號
                const bodyText = docData.body?.content?.map(c => c.paragraph?.elements?.map(e => e.textRun?.content).join('')).join('') || '';
                const entryCount = (bodyText.match(/【第 \d+ 條】/g) || []).length + 1;

                // Step 4: 組合要追加的內容（分成標題部分和描述部分）
                const separator = endIndex > 2 ? '\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n' : '';
                
                // 標題部分（圖片之前）
                const headerText = `${separator}【第 ${entryCount} 條】${zodiac?.symbol || '⚜️'} ${zodiac?.name || '黃金聖衣'}
📅 ${dateStr}

`;

                // 描述部分（圖片之後）
                const descriptionText = `

${analysis?.description ? `📖 描述：\n${analysis.description}\n` : ''}
${analysis?.features ? `⚔️ 特徵：\n${analysis.features}\n` : ''}
${analysis?.style ? `🎨 風格：\n${analysis.style}\n` : ''}
${analysis?.tags?.length ? `🏷️ 標籤：${analysis.tags.join('、')}\n` : ''}
📐 相框：${appState.currentFrame || '無'} | 濾鏡：${appState.currentFilter || '無'}
`;

                // Step 5: 使用 batchUpdate 插入文字和圖片
                // 注意：requests 會從後往前執行，所以要反向排列
                console.log('Step 5: 插入圖文內容...');
                
                const insertIndex = endIndex - 1;
                
                const updateResponse = await fetch(
                    `https://docs.googleapis.com/v1/documents/${docId}:batchUpdate`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token.access_token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            requests: [
                                // 1. 先插入標題文字
                                {
                                    insertText: {
                                        location: { index: insertIndex },
                                        text: headerText
                                    }
                                }
                            ]
                        })
                    }
                );

                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    console.error('插入標題失敗:', errorData);
                    throw new Error('插入內容失敗');
                }

                // 重新取得文件以獲得新的 endIndex
                const docResponse2 = await fetch(
                    `https://docs.googleapis.com/v1/documents/${docId}`,
                    {
                        headers: { 'Authorization': 'Bearer ' + token.access_token }
                    }
                );
                const docData2 = await docResponse2.json();
                const newEndIndex = docData2.body?.content?.slice(-1)[0]?.endIndex || 1;

                // Step 6: 插入圖片
                console.log('Step 6: 插入圖片...');
                const imageInsertResponse = await fetch(
                    `https://docs.googleapis.com/v1/documents/${docId}:batchUpdate`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token.access_token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            requests: [
                                {
                                    insertInlineImage: {
                                        location: { index: newEndIndex - 1 },
                                        uri: imageUrl,
                                        objectSize: {
                                            width: { magnitude: 400, unit: 'PT' },
                                            height: { magnitude: 400, unit: 'PT' }
                                        }
                                    }
                                }
                            ]
                        })
                    }
                );

                if (!imageInsertResponse.ok) {
                    const errorData = await imageInsertResponse.json();
                    console.error('插入圖片失敗:', errorData);
                    // 圖片插入失敗不中斷，繼續插入文字
                    console.log('圖片嵌入失敗，改用連結方式');
                }

                // 重新取得文件以獲得新的 endIndex
                const docResponse3 = await fetch(
                    `https://docs.googleapis.com/v1/documents/${docId}`,
                    {
                        headers: { 'Authorization': 'Bearer ' + token.access_token }
                    }
                );
                const docData3 = await docResponse3.json();
                const finalEndIndex = docData3.body?.content?.slice(-1)[0]?.endIndex || 1;

                // Step 7: 插入描述文字
                console.log('Step 7: 插入描述文字...');
                await fetch(
                    `https://docs.googleapis.com/v1/documents/${docId}:batchUpdate`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token.access_token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            requests: [
                                {
                                    insertText: {
                                        location: { index: finalEndIndex - 1 },
                                        text: descriptionText
                                    }
                                }
                            ]
                        })
                    }
                );

                const docUrl = `https://docs.google.com/document/d/${docId}/edit`;

                // 顯示成功彈窗
                showUploadSuccessModal('📖', '已追加到圖鑑！', {
                    type: 'docs',
                    fileName: docTitle,
                    fileUrl: docUrl,
                    imageUrl: imageUrl,
                    zodiac: zodiac,
                    dateStr: dateStr,
                    isAppend: true,
                    entryNumber: entryCount
                });

                // 發送 LINE 通知
                await sendLineNotifyViaGAS(`📖 已追加到圖鑑！

📄 ${docTitle}
⚜️ 【第 ${entryCount} 條】${zodiac?.symbol || ''} ${zodiac?.name || '黃金聖衣'}
📅 ${dateStr}

🔗 ${docUrl}`);

                // 保存到歷史
                saveToHistory({
                    type: 'google-docs',
                    zodiac: zodiac,
                    imageData: imageData,
                    analysis: analysis,
                    docUrl: docUrl,
                    timestamp: Date.now()
                });

            } catch (error) {
                console.error('Google Docs upload error:', error);
                
                if (error.message.includes('invalid_grant') || error.message.includes('Token')) {
                    showToast('error', '授權已過期，請重新授權');
                    clearGoogleAuth();
                } else {
                    showToast('error', '上傳失敗：' + error.message);
                }
            }
        }

        // HTML 轉義函數
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendLineBot() {
            if (!appState.credentials.line || !appState.credentials.line.channelToken) {
                showToast('error', '請先設定 LINE Bot Channel Token');
                return;
            }

            if (!appState.credentials.line.userId) {
                showToast('error', '請輸入您的 LINE User ID 以接收通知');
                return;
            }

            const zodiac = appState.generatedImages[appState.selectedResult]?.zodiac;
            const analysis = appState.currentAnalysis;

            const message = `🏆 黃金聖衣生成完成！

⚜️ 星座：${zodiac?.symbol} ${zodiac?.name}
📅 時間：${new Date().toLocaleString('zh-TW')}

📖 描述：
${analysis?.description || '無'}

🏷️ 標籤：${analysis?.tags?.join(', ') || '無'}

---
黃金聖衣生成器 V2`;

            await sendLineBotMessage(message);
        }

        async function sendLineBotMessage(message) {
            const channelToken = appState.credentials.line.channelToken;
            const userId = appState.credentials.line.userId;
            const gasUrl = appState.credentials.line.gasUrl;

            // 如果有設定 GAS URL，使用 GAS 代理 (解決 CORS)
            if (gasUrl) {
                showToast('info', '正在透過 GAS 發送 LINE 訊息...');
                
                try {
                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify({
                            action: 'pushMessage',
                            channelToken: channelToken,
                            userId: userId,
                            message: message
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        showToast('line', '🤖 LINE 訊息發送成功！');
                    } else {
                        showToast('error', 'LINE 發送失敗: ' + (result.error || '未知錯誤'));
                    }
                } catch (error) {
                    showToast('error', 'GAS 連線失敗: ' + error.message);
                }
            } else {
                // 沒有 GAS URL，顯示手動操作說明
                showModal(
                    '🤖',
                    'LINE Bot 通知',
                    `📝 訊息內容：\n${message}\n\n⚠️ 尚未設定 GAS 網址\n\n請設定 Google Apps Script 後端以自動發送 LINE 訊息。\n\n📋 GAS 部署步驟：\n1. 前往 script.google.com\n2. 建立新專案\n3. 貼上 GAS_LINE_BOT.gs 程式碼\n4. 部署為網頁應用程式\n5. 複製網址到設定欄位`,
                    closeModal
                );
            }
        }

        async function shareImage() {
            const canvas = document.getElementById('preview-canvas');
            const zodiac = appState.generatedImages[appState.selectedResult]?.zodiac;
            const dateStr = new Date().toLocaleString('zh-TW');
            
            canvas.toBlob(async (blob) => {
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: '黃金聖衣生成器',
                            text: '看看我的黃金聖衣！',
                            files: [new File([blob], 'gold-cloth.png', { type: 'image/png' })]
                        });
                        showToast('success', '分享成功！');
                        
                        // 發送 LINE 通知
                        await sendLineNotifyViaGAS(`📤 圖像已分享！\n\n⚜️ ${zodiac?.symbol || ''} ${zodiac?.name || '黃金聖衣'}\n📅 ${dateStr}`);
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            showToast('error', '分享失敗');
                        }
                    }
                } else {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showToast('success', '圖像已複製到剪貼板！');
                        
                        // 發送 LINE 通知
                        await sendLineNotifyViaGAS(`📋 圖像已複製到剪貼板！\n\n⚜️ ${zodiac?.symbol || ''} ${zodiac?.name || '黃金聖衣'}\n📅 ${dateStr}`);
                    } catch {
                        showToast('error', '您的瀏覽器不支援分享功能');
                    }
                }
            }, 'image/png');
        }

        // ==================== 歷史記錄 ====================
        async function showHistory() {
            const historyPanel = document.getElementById('history-panel');
            historyPanel.classList.toggle('active');
            
            if (historyPanel.classList.contains('active')) {
                await updateHistoryGrid();
                await updateHistoryStats();
            }
        }

        async function updateHistoryGrid() {
            const grid = document.getElementById('history-grid');
            grid.innerHTML = '';

            try {
                const history = await db.getAllHistory();
                
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <img class="history-image" src="${item.image}" alt="${item.zodiac}">
                        <div class="history-info">
                            <div class="history-zodiac">${item.zodiac}</div>
                            <div class="history-date">${new Date(item.createdAt).toLocaleDateString('zh-TW')}</div>
                            <div class="history-actions">
                                <button class="history-action-btn view" onclick="viewHistoryItem(${item.id})">👁️</button>
                                <button class="history-action-btn delete" onclick="deleteHistoryItem(${item.id})">🗑️</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(div);
                });

                if (history.length === 0) {
                    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--purple-light); padding: 40px;">尚無生成歷史</div>';
                }
            } catch (error) {
                console.error('載入歷史失敗:', error);
            }
        }

        async function updateHistoryStats() {
            try {
                const history = await db.getAllHistory();
                const storage = await db.getStorageEstimate();

                document.getElementById('stat-total').textContent = history.length;
                document.getElementById('stat-storage').textContent = formatBytes(storage.used);

                // 計算最常用星座
                const zodiacCount = {};
                history.forEach(item => {
                    zodiacCount[item.zodiac] = (zodiacCount[item.zodiac] || 0) + 1;
                });
                
                const topZodiac = Object.entries(zodiacCount).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('stat-zodiac').textContent = topZodiac ? topZodiac[0] : '-';
            } catch (error) {
                console.error('更新統計失敗:', error);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        async function viewHistoryItem(id) {
            showToast('info', `查看歷史記錄 #${id}`);
        }

        async function deleteHistoryItem(id) {
            try {
                await db.deleteHistory(id);
                await updateHistoryGrid();
                await updateHistoryStats();
                showToast('success', '記錄已刪除');
            } catch (error) {
                showToast('error', '刪除失敗');
            }
        }

        // ==================== 人物一致性控制 ====================
        function updateConsistencyValue(value) {
            document.getElementById('consistency-value').textContent = value + '%';
        }

        // ==================== UI 輔助函數 ====================
        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                line: '💬'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // 顯示上傳成功彈窗（可開啟檔案/資料夾）
        function showUploadSuccessModal(icon, title, data) {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalIcon = document.getElementById('modal-icon');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalConfirmBtn = document.querySelector('.modal-btn.confirm');

            modalIcon.textContent = icon;
            modalTitle.textContent = title;

            let content = '';
            
            if (data.type === 'photos') {
                content = `
                    <div style="text-align: left; line-height: 1.8;">
                        <p>✅ 圖片已成功上傳！</p>
                        <p>📁 <strong>相簿：</strong>${data.folderName}</p>
                        <p>📄 <strong>檔名：</strong>${data.fileName}</p>
                        <p>⚜️ <strong>星座：</strong>${data.zodiac?.symbol || ''} ${data.zodiac?.name || '黃金聖衣'}</p>
                        <p>📅 <strong>時間：</strong>${data.dateStr}</p>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                            <button onclick="window.open('${data.fileUrl}', '_blank')" 
                                    style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                🖼️ 開啟圖片
                            </button>
                            <button onclick="window.open('${data.folderUrl}', '_blank')" 
                                    style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                📁 開啟相簿
                            </button>
                        </div>
                    </div>
                `;
            } else if (data.type === 'docs') {
                const actionText = data.isAppend ? '已追加新內容到圖鑑！' : '圖鑑文件已建立！';
                content = `
                    <div style="text-align: left; line-height: 1.8;">
                        <p>✅ ${actionText}</p>
                        <p>📖 <strong>圖鑑：</strong>${data.fileName}</p>
                        <p>⚜️ <strong>新增：</strong>${data.zodiac?.symbol || ''} ${data.zodiac?.name || '黃金聖衣'}</p>
                        <p>📅 <strong>時間：</strong>${data.dateStr}</p>
                        
                        <p style="margin-top: 15px; background: #f0f8ff; padding: 10px; border-radius: 8px;">
                            💡 所有聖衣都會累積在同一份圖鑑文件中！
                        </p>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="window.open('${data.fileUrl}', '_blank')" 
                                    style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                📖 開啟圖鑑
                            </button>
                        </div>
                    </div>
                `;
            }

            modalText.innerHTML = content;
            modalOverlay.classList.add('active');
            
            // 修改確認按鈕為關閉
            modalConfirmBtn.textContent = '關閉';
            window.modalConfirmCallback = closeModal;
        }

        function showModal(icon, title, text, onConfirm) {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            document.getElementById('modal-overlay').classList.add('active');
            
            // 重置確認按鈕文字
            const confirmBtn = document.querySelector('.modal-btn.confirm');
            if (confirmBtn) confirmBtn.textContent = '確認';
            
            window.modalConfirmCallback = onConfirm;
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            // 重置確認按鈕文字
            const confirmBtn = document.querySelector('.modal-btn.confirm');
            if (confirmBtn) confirmBtn.textContent = '確認';
        }

        function modalConfirm() {
            if (window.modalConfirmCallback) {
                window.modalConfirmCallback();
            }
            closeModal();
        }

        function showGoogleDocsHelp() {
            showModal(
                '📄',
                'Google Docs 整合說明',
                `使用 Google Docs API 需要：

1. 前往 Google Cloud Console
2. 建立專案並啟用 Google Docs API
3. 建立 API 金鑰或 OAuth 憑證
4. 將金鑰輸入上方認證管理區

注意：完整功能需要後端服務支援
詳情請參考 Google Docs API 文件`,
                closeModal
            );
        }

        function showGooglePhotosHelp() {
            showModal(
                '📷',
                'Google Photos API 設定說明',
                `上傳圖片到 Google 相簿需要 OAuth 2.0 授權：

📋 設定步驟：

1️⃣ 前往 Google Cloud Console
   https://console.cloud.google.com/

2️⃣ 建立專案或選擇現有專案

3️⃣ 啟用 Photos Library API
   APIs & Services → Library → 搜尋 "Photos Library API"

4️⃣ 建立 OAuth 2.0 憑證
   APIs & Services → Credentials → Create Credentials
   → OAuth client ID → Web application

5️⃣ 設定 OAuth 同意畫面
   加入範圍：photoslibrary.appendonly, photoslibrary.readonly

6️⃣ 取得 Client ID 和 Client Secret
   填入認證管理區

🖼️ 功能特色：
• 自動加入日期浮水印
• 自動加入相框效果
• 支援自訂相簿名稱
• 上傳後可發送 LINE Bot 通知

⚠️ 完整的 OAuth 流程需要後端服務支援`,
                closeModal
            );
        }

        function showLineHelp() {
            showModal(
                '🤖',
                'LINE Bot + GAS 整合說明',
                `⚠️ LINE Notify 已於 2025/3/31 停止服務
官方替代方案：LINE Messaging API + GAS 後端

📋 設定步驟：

【步驟 1】建立 LINE Bot
1. 前往 LINE Developers Console
   https://developers.line.biz/
2. 建立 Messaging API Channel
3. 取得 Channel Access Token (長效)

【步驟 2】取得 User ID
1. 將 Bot 加為好友
2. 傳訊息給 Bot（需設定 Webhook）
3. 或使用 LINE 官方工具取得

【步驟 3】部署 GAS 後端 ⭐重要
1. 前往 script.google.com
2. 建立新專案
3. 貼上 GAS_LINE_BOT.gs 程式碼
4. 部署 → 新增部署 → 網頁應用程式
5. 執行身分：我
6. 誰可以存取：所有人
7. 複製網址貼到「GAS 網址」欄位

💰 費用：每月免費 200 則訊息`,
                closeModal
            );
        }

        function resetApp() {
            appState.selectedZodiac = null;
            appState.uploadedImage = null;
            appState.generatedImages = [];
            appState.selectedResult = null;
            appState.currentAnalysis = null;
            
            document.querySelectorAll('.zodiac-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('upload-zone').classList.remove('has-image');
            document.getElementById('upload-preview').src = '';
            document.getElementById('results-section').classList.remove('active');
            document.getElementById('ai-analysis-panel').classList.remove('active');
            document.getElementById('editor-panel').classList.remove('active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('info', '已重置應用程式');
        }

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', initSplashScreen);
    </script>
</body>
</html>
